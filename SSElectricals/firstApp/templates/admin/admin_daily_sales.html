{% extends 'admin/base_admin.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Daily Sales Records</h2>
    <div>
        <div class="btn-group me-2">
            <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="fas fa-download"></i> Export
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{% url 'admin_export_sales' %}?format=csv"><i
                            class="fas fa-file-csv me-2"></i>CSV</a></li>
                <li><a class="dropdown-item" href="{% url 'admin_export_sales' %}?format=tsv"><i
                            class="fas fa-file-alt me-2"></i>TSV</a></li>
                <li><a class="dropdown-item" href="{% url 'admin_export_sales' %}?format=pdf"><i
                            class="fas fa-file-pdf me-2"></i>PDF</a></li>
                <li><a class="dropdown-item" href="{% url 'admin_export_sales' %}?format=word"><i
                            class="fas fa-file-word me-2"></i>Word</a></li>
            </ul>
        </div>
        <a href="{% url 'admin_upload_sales' %}" class="btn btn-info me-2 text-white"><i class="fas fa-file-upload"></i>
            Upload Bulk</a>
        <a href="{% url 'admin_add_daily_sales' %}" class="btn btn-primary"><i class="fas fa-plus"></i> Add Sales
            Entry</a>
    </div>
</div>

<!-- Filter Form -->
<form method="get" class="mb-4 bg-white p-4 rounded shadow-sm border">
    <div class="row g-3">
        <div class="col-md-3">
            <label class="form-label small text-muted">Specific Date</label>
            <input type="date" name="date" class="form-control" value="{{ request.GET.date }}">
        </div>
        <div class="col-md-3">
            <label class="form-label small text-muted">Month</label>
            <input type="month" name="month" class="form-control" value="{{ request.GET.month }}">
        </div>
        <div class="col-md-2">
            <label class="form-label small text-muted">Year</label>
            <input type="number" name="year" class="form-control" placeholder="YYYY" min="2000" max="2100"
                value="{{ request.GET.year }}">
        </div>
        <div class="col-md-2">
            <label class="form-label small text-muted">Day</label>
            <select name="day_name" class="form-select">
                <option value="">All Days</option>
                <option value="Monday" {% if request.GET.day_name == "Monday" %}selected{% endif %}>Monday</option>
                <option value="Tuesday" {% if request.GET.day_name == "Tuesday" %}selected{% endif %}>Tuesday</option>
                <option value="Wednesday" {% if request.GET.day_name == "Wednesday" %}selected{% endif %}>Wednesday
                </option>
                <option value="Thursday" {% if request.GET.day_name == "Thursday" %}selected{% endif %}>Thursday</option>
                <option value="Friday" {% if request.GET.day_name == "Friday" %}selected{% endif %}>Friday</option>
                <option value="Saturday" {% if request.GET.day_name == "Saturday" %}selected{% endif %}>Saturday</option>
                <option value="Sunday" {% if request.GET.day_name == "Sunday" %}selected{% endif %}>Sunday</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label small text-muted">Date Range</label>
            <div class="input-group">
                <input type="date" name="start_date" class="form-control" placeholder="Start"
                    value="{{ request.GET.start_date }}">
                <span class="input-group-text">to</span>
                <input type="date" name="end_date" class="form-control" placeholder="End"
                    value="{{ request.GET.end_date }}">
            </div>
        </div>
        <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary"><i class="fas fa-filter me-1"></i> Apply Filters</button>
            <a href="{% url 'admin_daily_sales' %}" class="btn btn-secondary ms-2">Clear</a>
        </div>
    </div>
</form>

<!-- Summary Stats -->
{% if total_sales > 0 %}
<div class="row mb-4 g-3">
    <div class="col-md-4">
        <div class="card stat-card-primary shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="card-title mb-0">
                    <i class="fas fa-hand-holding-usd me-2"></i>Total Sales
                    <small class="d-block mt-1" style="font-size: 0.7rem; opacity: 0.7;">
                        (Filtered Results)
                    </small>
                </h6>
                <h3 class="my-2 stat-value">₹{{ total_sales }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card-success shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="card-title mb-0">
                    <i class="fas fa-credit-card me-2"></i>Online Received
                    <small class="d-block mt-1" style="font-size: 0.7rem; opacity: 0.7;">
                        (Manual Entry)
                    </small>
                </h6>
                <h3 class="my-2 stat-value">₹{{ total_online }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card-warning shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="card-title mb-0">
                    <i class="fas fa-money-bill-wave me-2"></i>Cash Received
                    <small class="d-block mt-1" style="font-size: 0.7rem; opacity: 0.7;">
                        (Manual Entry)
                    </small>
                </h6>
                <h3 class="my-2 stat-value">₹{{ total_cash }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Second Row - Additional Charges -->
<div class="row mb-4 g-3">
    <div class="col-md-4 offset-md-2">
        <div class="card stat-card-danger shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="card-title mb-0">
                    <i class="fas fa-tools me-2"></i>Labor Charge
                    <small class="d-block mt-1" style="font-size: 0.7rem; opacity: 0.7;">
                        (Additional Charges)
                    </small>
                </h6>
                <h3 class="my-2 stat-value">₹{{ total_labor }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card-success shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="card-title mb-0">
                    <i class="fas fa-truck me-2"></i>Delivery Charge
                    <small class="d-block mt-1" style="font-size: 0.7rem; opacity: 0.7;">
                        (Additional Charges)
                    </small>
                </h6>
                <h3 class="my-2 stat-value">₹{{ total_delivery }}</h3>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="card shadow border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="sorting-info">
                    <i class="fas fa-info-circle"></i>
                    <span>Sorted by: <strong>{{ current_sort_by|title }}</strong> ({{ current_sort_order|upper}})</span>
                </div>
                <a href="?sort=date&order=desc" class="btn btn-sm btn-outline-secondary btn-reset-sort">
                    <i class="fas fa-undo me-1"></i> Reset to Default
                </a>
            </div>
            <table class="table table-hover table-striped mb-0 align-middle">
                <thead class="bg-primary text-white">
                    <tr>
                        {% include 'admin/sortable_header.html' with column='date' label='Date' %}
                        {% include 'admin/sortable_header.html' with column='day' label='Day' %}
                        {% include 'admin/sortable_header.html' with column='total_sales' label='Total Sales(₹)' %}
                        {% include 'admin/sortable_header.html' with column='online_received' label='Online(₹)' %}
                        {% include 'admin/sortable_header.html' with column='cash_received' label='Cash(₹)' %}
                        {% include 'admin/sortable_header.html' with column='labor_charge' label='Labor(₹)' %}
                        {% include 'admin/sortable_header.html' with column='delivery_charge' label='Delivery(₹)' %}
                        {% include 'admin/sortable_header.html' with column='subtotal' label='Subtotal(₹)' %}
                        <th>Remarks</th>
                        <th>Admin</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales_records %}
                    <tr>
                        <td class="ps-3">{{ sale.date }}</td>
                        <td>{{ sale.day }}</td>
                        <td class="fw-bold text-primary">₹{{ sale.total_sales }}</td>
                        <td class="text-success">₹{{ sale.online_received }}</td>
                        <td class="text-info">₹{{ sale.cash_received }}</td>
                        <td class="text-warning">₹{{ sale.labor_charge|default:"0.00" }}</td>
                        <td class="text-secondary">₹{{ sale.delivery_charge|default:"0.00" }}</td>
                        <td><strong>₹{{ sale.subtotal }}</strong></td>
                        <td>
                            {{ sale.remark }}
                            {% if sale.remark == 'Other' and sale.other_remark %}
                            <br><small class="text-muted">{{ sale.other_remark }}</small>
                            {% endif %}
                        </td>
                        <td><span class="badge bg-light text-dark border">{{ sale.admin.username }}</span></td>
                        <td class="text-end pe-3">
                            <a href="{% url 'admin_edit_daily_sales' sale.id %}"
                                class="btn btn-sm btn-outline-primary border-0"><i class="fas fa-edit"></i></a>
                            <a href="{% url 'admin_delete_daily_sales' sale.id %}"
                                class="btn btn-sm btn-outline-danger border-0"
                                onclick="return confirm('Delete this record?')"><i class="fas fa-trash"></i></a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="11" class="text-center py-5 text-muted">No sales records found for the selected
                            criteria.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if sales_records.has_other_pages %}
        <nav aria-label="Page navigation" class="p-3 border-top">
            <ul class="pagination justify-content-center mb-0">
                {% if sales_records.has_previous %}
                <li class="page-item">
                    <a class="page-link"
                        href="?page={{ sales_records.previous_page_number }}&date={{ request.GET.date }}&month={{ request.GET.month }}&year={{ request.GET.year }}&start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}">Previous</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
                {% endif %}

                {% for i in sales_records.paginator.page_range %}
                {% if sales_records.number == i %}
                <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                {% else %}
                <li class="page-item"><a class="page-link"
                        href="?page={{ i }}&date={{ request.GET.date }}&month={{ request.GET.month }}&year={{ request.GET.year }}&start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}">
                        {{ i }}</a></li>
                {% endif %}
                {% endfor %}

                {% if sales_records.has_next %}
                <li class="page-item">
                    <a class="page-link"
                        href="?page={{ sales_records.next_page_number }}&date={{ request.GET.date }}&month={{ request.GET.month }}">Next</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<script>
    // Table Sorting JavaScript
    function initTableSorting() {
        // Helper function to build sort URL
        function getSortUrl(column) {
            const urlParams = new URLSearchParams(window.location.search);
            const currentSort = urlParams.get('sort_by');
            const currentOrder = urlParams.get('sort_order') || 'desc';

            // Toggle order if same column, otherwise default to desc
            let newOrder = 'desc';
            if (currentSort === column) {
                newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
            }

            urlParams.set('sort_by', column);
            urlParams.set('sort_order', newOrder);

            // Reset to page 1 when sorting
            urlParams.set('page', '1');

            return `?${urlParams.toString()}`;
        }

        // Add click handlers to sortable headers
        const sortableHeaders = document.querySelectorAll('.sortable-header');
        sortableHeaders.forEach(header => {
            header.addEventListener('click', function () {
                const column = this.dataset.column;
                window.location.href = getSortUrl(column);
            });
        });

        // Reset sort button (if you add one)
        const resetBtn = document.getElementById('resetSortBtn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function () {
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.delete('sort_by');
                urlParams.delete('sort_order');
                urlParams.set('page', '1');

                const newParams = urlParams.toString();
                window.location.href = newParams ? `?${newParams}` : window.location.pathname;
            });
        }
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTableSorting);
    } else {
        initTableSorting();
    }
</script>
{% endblock %}