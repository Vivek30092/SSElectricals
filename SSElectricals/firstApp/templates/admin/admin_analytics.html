{% extends 'admin/base_admin.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-bar me-2"></i>Analytics & Insights</h2>
</div>

<!-- Global Filters -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label small text-muted">Start Date</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">End Date</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">Month</label>
                <input type="month" name="month" class="form-control" value="{{ month }}">
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary mt-4 w-100">
                    <i class="fas fa-filter me-1"></i> Apply Filters
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Time View & Export Bar -->
<div class="card shadow-sm border-0 mb-4" style="position: sticky; top: 0; z-index: 100;">
    <div class="card-body py-2">
        <div class="row align-items-center g-2">
            <div class="col-md-6">
                <label class="small text-muted me-2">View:</label>
                <div class="btn-group btn-group-sm" role="group">
                    <a href="?time_view=daily&{{ request.GET.urlencode }}"
                        class="btn btn-outline-primary {% if time_view == 'daily' %}active{% endif %}">Daily</a>
                    <a href="?time_view=monthly&{{ request.GET.urlencode }}"
                        class="btn btn-outline-primary {% if time_view == 'monthly' or not time_view %}active{% endif %}">Monthly</a>
                    <a href="?time_view=quarterly&{{ request.GET.urlencode }}"
                        class="btn btn-outline-primary {% if time_view == 'quarterly' %}active{% endif %}">Quarterly</a>
                    <a href="?time_view=yearly&{{ request.GET.urlencode }}"
                        class="btn btn-outline-primary {% if time_view == 'yearly' %}active{% endif %}">Yearly</a>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group btn-group-sm">
                    <a href="?export=csv&{{ request.GET.urlencode }}" class="btn btn-success">
                        <i class="fas fa-file-csv me-1"></i> CSV
                    </a>
                    <a href="?export=excel&{{ request.GET.urlencode }}" class="btn btn-primary">
                        <i class="fas fa-file-excel me-1"></i> Excel
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tab Navigation -->
<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#sales">
            <i class="fas fa-dollar-sign me-2"></i>Sales
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#expenses">
            <i class="fas fa-wallet me-2"></i>Expenses
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#combined">
            <i class="fas fa-chart-line me-2"></i>Combined
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content">

    <!-- SALES TAB -->
    <div class="tab-pane fade show active" id="sales">

        <!-- KPI Cards -->
        <div class="row mb-4 g-3">
            <div class="col-md-2-4">
                <div class="card stat-card-primary h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Total Sales</h6>
                        <h3 class="stat-value">₹{{ total_sales|floatformat:2 }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2-4">
                <div class="card stat-card-success h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Avg Daily</h6>
                        <h3 class="stat-value">₹{{ avg_sales|floatformat:2 }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2-4">
                <div class="card stat-card-warning h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Online ({{ online_pct|floatformat:1 }}%)</h6>
                        <h3 class="stat-value">₹{{ total_online_sales|floatformat:2 }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2-4">
                <div class="card stat-card-danger h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Labor</h6>
                        <h3 class="stat-value">₹{{ total_labor|floatformat:2 }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2-4">
                <div class="card stat-card-primary h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Delivery</h6>
                        <h3 class="stat-value">₹{{ total_delivery|floatformat:2 }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Min/Max Insight Cards -->
        <div class="row mb-4 g-3">
            <div class="col-md-3">
                <div class="card border-success h-100">
                    <div class="card-body">
                        <h6 class="text-success mb-1">
                            <i class="fas fa-arrow-up me-1"></i>Best Sales Day
                        </h6>
                        {% if max_sale_day %}
                        <p class="mb-0 small text-muted">{{ max_sale_day.date|date:"d M, Y" }}</p>
                        <h4 class="text-success mb-0">₹{{ max_sale_day.total_sales|floatformat:2 }}</h4>
                        {% else %}
                        <p class="text-muted">No data</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger h-100">
                    <div class="card-body">
                        <h6 class="text-danger mb-1">
                            <i class="fas fa-arrow-down me-1"></i>Lowest Sales Day
                        </h6>
                        {% if min_sale_day %}
                        <p class="mb-0 small text-muted">{{ min_sale_day.date|date:"d M, Y" }}</p>
                        <h4 class="text-danger mb-0">₹{{ min_sale_day.total_sales|floatformat:2 }}</h4>
                        {% else %}
                        <p class="text-muted">No data</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success h-100">
                    <div class="card-body">
                        <h6 class="text-success mb-1">
                            <i class="fas fa-trophy me-1"></i>Best Month
                        </h6>
                        <p class="mb-0 small text-muted">{{ max_sales_month }}</p>
                        <h4 class="text-success mb-0">₹{{ max_sales_month_value|floatformat:2 }}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning h-100">
                    <div class="card-body">
                        <h6 class="text-warning mb-1">
                            <i class="fas fa-calendar-check me-1"></i>Averages
                        </h6>
                        <p class="mb-0 small">Daily: ₹{{ daily_avg_sales|floatformat:2 }}</p>
                        <p class="mb-0 small">Monthly: ₹{{ monthly_avg_sales|floatformat:2 }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">Daily Sales Trend</div>
                    <div class="card-body" style="height: 400px;">
                        <canvas id="dailySalesChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">Payment Mode</div>
                    <div class="card-body" style="height: 400px;">
                        <canvas id="paymentPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">Monthly Sales & Growth</div>
                    <div class="card-body" style="height: 350px;">
                        <canvas id="monthlySalesChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">Quarterly Performance</div>
                    <div class="card-body" style="height: 350px;">
                        <canvas id="quarterlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 3 -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">Yearly Trend</div>
                    <div class="card-body" style="height: 350px;">
                        <canvas id="yearlyChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">Weekday Performance</div>
                    <div class="card-body" style="height: 350px;">
                        <canvas id="weekdayChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Best/Worst Period Alerts -->
        {% if best_month_info %}
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="alert alert-success border-success">
                    <h5 class="alert-heading">
                        <i class="fas fa-star me-2"></i>Best Performing Period
                    </h5>
                    <hr>
                    <p class="mb-0"><strong>{{ best_month_info.type }}:</strong> {{ best_month_info.period }}</p>
                    <h3 class="mt-2 mb-0">₹{{ best_month_info.value|floatformat:2 }}</h3>
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-warning border-warning">
                    <h5 class="alert-heading">
                        <i class="fas fa-exclamation-triangle me-2"></i>Needs Attention
                    </h5>
                    <hr>
                    <p class="mb-0"><strong>{{ worst_month_info.type }}:</strong> {{ worst_month_info.period }}</p>
                    <h3 class="mt-2 mb-0">₹{{ worst_month_info.value|floatformat:2 }}</h3>
                </div>
            </div>
        </div>
        {% endif %}

    </div>

    <!-- EXPENSES TAB -->
    <div class="tab-pane fade" id="expenses">

        <!-- KPI Cards -->
        <div class="row mb-4 g-3">
            <div class="col-md-4">
                <div class="card stat-card-danger h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Total Expenses</h6>
                        <h3 class="stat-value">₹{{ total_expense|floatformat:2 }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card-success h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Avg Daily</h6>
                        <h3 class="stat-value">₹{{ avg_expense|floatformat:2 }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card-warning h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Online ({{ online_exp_pct|floatformat:1 }}%)</h6>
                        <h3 class="stat-value">₹{{ total_online_exp|floatformat:2 }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">Daily Expense Trend</div>
                    <div class="card-body" style="height: 400px;">
                        <canvas id="dailyExpenseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- COMBINED TAB -->
    <div class="tab-pane fade" id="combined">

        <!-- Net Contribution -->
        <div class="card stat-card-{{ contribution_color }} mb-4">
            <div class="card-body">
                <h5>Net Contribution</h5>
                <h2 class="stat-value">₹{{ net_contribution|floatformat:2 }}</h2>
                <p class="mb-0 small">Sales - (Labor + Delivery + Expenses)</p>
            </div>
        </div>

        <!-- Comparison Chart -->
        <div class="card">
            <div class="card-header">Sales vs Expenses</div>
            <div class="card-body" style="height: 450px;">
                <canvas id="salesVsExpenseChart"></canvas>
            </div>
        </div>

    </div>

</div>

{% endblock %}

{% block extra_css %}
<style>
    .col-md-2-4 {
        flex: 0 0 auto;
        width: 20%;
    }

    @media (max-width: 768px) {
        .col-md-2-4 {
            width: 100%;
        }
    }

    .nav-tabs .nav-link.active {
        color: #7B5CFA;
        border-bottom: 3px solid #7B5CFA;
    }

    .border-success {
        border-left: 4px solid #10b981 !important;
    }

    .border-danger {
        border-left: 4px solid #ec4899 !important;
    }

    .border-warning {
        border-left: 4px solid #f59e0b !important;
    }

    .card[style*="sticky"] {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
    }

    body.dark-mode .card[style*="sticky"] {
        background: rgba(14, 11, 31, 0.95);
    }

    .card {
        transition: all 0.3s ease;
    }

    .alert {
        border-left-width: 4px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Helper function to safely parse JSON
    function safeJSONParse(jsonString, fallback = []) {
        try {
            if (!jsonString || jsonString === '[]' || jsonString === '') {
                return fallback;
            }
            return JSON.parse(jsonString);
        } catch (e) {
            console.warn('JSON parse error:', e);
            return fallback;
        }
    }

    // Daily Sales Chart
    const dailySalesChart = new Chart(document.getElementById('dailySalesChart'), {
        type: 'bar',
        data: {
            labels: safeJSONParse('{{ sales_dates_json|escapejs }}'),
            datasets: [{
                label: 'Sales',
                data: safeJSONParse('{{ sales_values_json|escapejs }}'),
                backgroundColor: 'rgba(123, 92, 250, 0.7)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Payment Pie Chart
    const paymentPieChart = new Chart(document.getElementById('paymentPieChart'), {
        type: 'pie',
        data: {
            labels: ['Online', 'Cash'],
            datasets: [{
                data: [{{ total_online_sales|default_if_none:0 }}, {{ total_cash_sales|default_if_none:0 }}],
                backgroundColor: ['#10b981', '#ec4899']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Monthly Sales Chart
    const monthlySalesChart = new Chart(document.getElementById('monthlySalesChart'), {
        type: 'line',
        data: {
            labels: safeJSONParse('{{ monthly_sales_labels_json|escapejs }}'),
            datasets: [{
                label: 'Monthly Sales',
                data: safeJSONParse('{{ monthly_sales_values_json|escapejs }}'),
                borderColor: '#4C5DD7',
                tension: 0.4,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Quarterly Chart
    const quarterlyChart = new Chart(document.getElementById('quarterlyChart'), {
        type: 'bar',
        data: {
            labels: safeJSONParse('{{ quarterly_labels_json|escapejs }}'),
            datasets: [{
                label: 'Quarterly Sales',
                data: safeJSONParse('{{ quarterly_values_json|escapejs }}'),
                backgroundColor: 'rgba(76, 93, 215, 0.7)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Yearly Chart
    const yearlyChart = new Chart(document.getElementById('yearlyChart'), {
        type: 'line',
        data: {
            labels: safeJSONParse('{{ yearly_labels_json|escapejs }}'),
            datasets: [{
                label: 'Yearly Sales',
                data: safeJSONParse('{{ yearly_values_json|escapejs }}'),
                borderColor: '#7B5CFA',
                tension: 0.4,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Weekday Chart
    const weekdayChart = new Chart(document.getElementById('weekdayChart'), {
        type: 'bar',
        data: {
            labels: safeJSONParse('{{ weekday_labels_json|escapejs }}'),
            datasets: [{
                label: 'Average Sales',
                data: safeJSONParse('{{ weekday_values_json|escapejs }}'),
                backgroundColor: 'rgba(255, 99, 132, 0.7)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Daily Expense Chart
    const dailyExpenseChart = new Chart(document.getElementById('dailyExpenseChart'), {
        type: 'line',
        data: {
            labels: safeJSONParse('{{ expense_dates_json|escapejs }}'),
            datasets: [{
                label: 'Expenses',
                data: safeJSONParse('{{ expense_values_json|escapejs }}'),
                borderColor: '#ec4899',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Sales vs Expense Chart
    const salesVsExpenseChart = new Chart(document.getElementById('salesVsExpenseChart'), {
        type: 'line',
        data: {
            labels: safeJSONParse('{{ sales_dates_json|escapejs }}'),
            datasets: [
                {
                    label: 'Sales',
                    data: safeJSONParse('{{ sales_values_json|escapejs }}'),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true
                },
                {
                    label: 'Expenses',
                    data: safeJSONParse('{{ expense_values_json|escapejs }}'),
                    borderColor: '#ec4899',
                    backgroundColor: 'rgba(236, 72, 153, 0.1)',
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
</script>
{% endblock %}