{% extends 'firstApp/base.html' %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-5">
        <div class="card shadow">
            <div class="card-body p-5">
                <h3 class="text-center mb-3">Enter OTP</h3>
                <p class="text-center text-muted">OTP sent to <strong>{{ phone_number }}</strong></p>

                <form method="post" id="otpForm">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label class="form-label text-center d-block">Enter 6-Digit OTP</label>
                        <div class="otp-inputs d-flex justify-content-center gap-2">
                            <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" required>
                            <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" required>
                            <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" required>
                            <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" required>
                            <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" required>
                            <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" required>
                        </div>
                        <input type="hidden" name="otp" id="otpValue">
                    </div>

                    <button type="submit" class="btn btn-warning btn-lg w-100">
                        <i class="fas fa-check-circle"></i> Verify OTP
                    </button>
                </form>

                <div class="text-center mt-4">
                    <p class="text-muted small">Didn't receive OTP?</p>
                    <button id="resendBtn" class="btn btn-outline-secondary" disabled>
                        Resend OTP (<span id="countdown">60</span>s)
                    </button>
                </div>

                <div class="text-center mt-3">
                    <a href="{% url 'otp_login' %}" class="text-muted small">‚Üê Change phone number</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .otp-input {
        width: 50px;
        height: 60px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        border: 2px solid #ddd;
        border-radius: 8px;
        transition: all 0.3s;
    }

    .otp-input:focus {
        border-color: #ffc107;
        box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        outline: none;
    }
</style>

<script>
    const otpInputs = document.querySelectorAll('.otp-input');
    const otpValue = document.getElementById('otpValue');
    const otpForm = document.getElementById('otpForm');
    const resendBtn = document.getElementById('resendBtn');
    const countdownEl = document.getElementById('countdown');

    // Auto-focus next input
    otpInputs.forEach((input, index) => {
        input.addEventListener('input', function (e) {
            // Only allow digits
            this.value = this.value.replace(/\D/g, '');

            // Move to next input
            if (this.value.length === 1 && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }

            // Update hidden input
            updateOTP();

            // Auto-submit when all filled
            if (index === otpInputs.length - 1 && this.value) {
                const allFilled = Array.from(otpInputs).every(inp => inp.value.length === 1);
                if (allFilled) {
                    setTimeout(() => otpForm.submit(), 300);
                }
            }
        });

        // Handle backspace
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Backspace' && !this.value && index > 0) {
                otpInputs[index - 1].focus();
            }
        });

        // Handle paste
        input.addEventListener('paste', function (e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
            pastedData.split('').forEach((char, i) => {
                if (otpInputs[i]) otpInputs[i].value = char;
            });
            updateOTP();
            otpInputs[Math.min(pastedData.length, 5)].focus();
        });
    });

    function updateOTP() {
        otpValue.value = Array.from(otpInputs).map(inp => inp.value).join('');
    }

    // Countdown timer for resend
    let countdown = 60;
    const timer = setInterval(() => {
        countdown--;
        countdownEl.textContent = countdown;

        if (countdown <= 0) {
            clearInterval(timer);
            resendBtn.disabled = false;
            resendBtn.innerHTML = '<i class="fas fa-redo"></i> Resend OTP';
        }
    }, 1000);

    // Resend OTP
    resendBtn.addEventListener('click', function () {
        this.disabled = true;
        fetch('{% url "resend_otp" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    countdown = 60;
                    const newTimer = setInterval(() => {
                        countdown--;
                        countdownEl.textContent = countdown;
                        if (countdown <= 0) {
                            clearInterval(newTimer);
                            resendBtn.disabled = false;
                            resendBtn.innerHTML = '<i class="fas fa-redo"></i> Resend OTP';
                        }
                    }, 1000);
                } else {
                    alert(data.message);
                    resendBtn.disabled = false;
                }
            });
    });

    // Focus first input on load
    otpInputs[0].focus();
</script>
{% endblock %}