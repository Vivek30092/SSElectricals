{% extends 'firstApp/base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <!-- Left Column: Checkout Form -->
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden mb-4">
                <div
                    class="card-header bg-gradient bg-primary text-white p-4 d-flex align-items-center justify-content-between">
                    <h2 class="mb-0 fw-bold h3"><i class="fas fa-shopping-cart me-2"></i>Checkout</h2>
                    <span class="badge bg-white text-primary fs-6 rounded-pill px-3 py-2">Secure Payment</span>
                </div>
                <div class="card-body p-5 bg-light">
                    <form method="post" novalidate id="checkoutForm">
                        {% csrf_token %}
                        <!-- Hidden fields for GPS data -->
                        <input type="hidden" name="latitude" id="id_latitude">
                        <input type="hidden" name="longitude" id="id_longitude">
                        <input type="hidden" name="distance_km" id="id_distance_km">

                        {% if form.non_field_errors %}
                        <div class="alert alert-danger rounded-3 shadow-sm">
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="bg-white p-4 rounded-3 shadow-sm mb-4">
                            <h5 class="mb-3 text-primary border-bottom pb-2"><i
                                    class="fas fa-map-marker-alt me-2"></i>Delivery Address</h5>

                            <!-- Google Places Autocomplete Search (Primary Method) -->
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Search Your Address <span
                                        class="text-danger">*</span></label>
                                <input type="text" id="addressAutocomplete" class="form-control form-control-lg"
                                    placeholder="Start typing your address in Indore..." autocomplete="off" />
                                <small class="form-text text-muted d-block mt-1">
                                    <i class="fas fa-info-circle"></i> Select your address from the dropdown for
                                    accurate distance calculation
                                </small>
                            </div>

                            <!-- Optional GPS Assist Button -->
                            <div class="mb-3">
                                <button class="btn btn-outline-primary w-100 mb-2" type="button" id="detectLocationBtn">
                                    <i class="fas fa-crosshairs me-1"></i> Auto-fill Address using GPS
                                </button>
                                <div id="locationMsg" class="form-text small"></div>
                            </div>

                            <!-- Interactive Map for Location Confirmation -->
                            <div class="mb-3" id="mapSection" style="display: none;">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-map me-1"></i> Confirm Your Location
                                </label>
                                <div id="mapContainer"
                                    style="height: 300px; border-radius: 8px; overflow: hidden; border: 2px solid #dee2e6;">
                                    <!-- Google Map loads here -->
                                </div>
                                <small class="form-text text-muted d-block mt-1">
                                    <i class="fas fa-hand-pointer"></i> Drag the red marker to adjust your exact
                                    location
                                </small>
                            </div>

                            <!-- Address Verification Status -->
                            <div id="verificationStatus" class="alert alert-info mb-3" style="display:none;">
                                <h6 class="mb-2">
                                    <i class="fas fa-shield-alt me-1"></i> Address Verification
                                </h6>
                                <div class="progress mb-2" style="height: 24px;">
                                    <div id="confidenceBar"
                                        class="progress-bar progress-bar-striped progress-bar-animated"
                                        role="progressbar" style="width: 0%;"></div>
                                </div>
                                <small id="verificationDetails" class="d-block"></small>
                            </div>

                            <!-- Address Details Section (Always Visible) -->
                            <div class="row g-2">
                                <div class="col-4">
                                    <label class="form-label small text-muted">House No. <span
                                            class="text-danger">*</span></label>
                                    {{ form.house_number }}
                                    {% if form.house_number.errors %}
                                    <div class="text-danger small">{{ form.house_number.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-8">
                                    <label class="form-label small text-muted">Address Line 1 <span
                                            class="text-danger">*</span></label>
                                    {{ form.address_line1 }}
                                    {% if form.address_line1.errors %}
                                    <div class="text-danger small">{{ form.address_line1.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="form-label small text-muted">Address Line 2 (Optional)</label>
                                {{ form.address_line2 }}
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-6">
                                    <label class="form-label small text-muted">Landmark</label>
                                    {{ form.landmark }}
                                </div>
                                <div class="col-6">
                                    <label class="form-label small text-muted">Pincode <span
                                            class="text-danger">*</span></label>
                                    {{ form.pincode }}
                                    {% if form.pincode.errors %}
                                    <div class="text-danger small">{{ form.pincode.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-6">
                                    <label class="form-label small text-muted">City</label>
                                    {{ form.city }}
                                </div>
                                <div class="col-6">
                                    <label class="form-label small text-muted">Area <span
                                            class="text-danger">*</span></label>
                                    {{ form.area }}
                                    <div id="otherAreaWrapper" style="display:none; margin-top: 8px;">
                                        <label class="form-label small text-muted">Enter your area name <span
                                                class="text-danger">*</span></label>
                                        {{ form.other_area }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-3 shadow-sm mb-4">
                            <h5 class="mb-3 text-primary border-bottom pb-2"><i
                                    class="fas fa-credit-card me-2"></i>Payment Method</h5>
                            <div class="mb-3">
                                {% for radio in form.payment_method %}
                                <div class="form-check">
                                    {{ radio.tag }}
                                    <label class="form-check-label" for="{{ radio.id_for_label }}">
                                        {{ radio.choice_label }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit"
                                class="btn btn-primary btn-lg py-3 rounded-3 fw-bold shadow-sm hover-lift"
                                id="placeOrderBtn">
                                <i class="fas fa-lock me-2"></i>Place Order
                            </button>
                            <p class="text-muted mt-2 small text-center">
                                * Calculated delivery distance may be approximate. We will contact you to confirm your
                                address if needed.
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Order Summary & Charges -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body p-4">
                    <!-- Products -->
                    <div class="mb-4">
                        <h6 class="text-muted text-uppercase small fw-bold mb-3">Product Name(s)</h6>
                        <ul class="list-unstyled mb-0">
                            {% for item in cart.items.all %}
                            <li class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <span class="d-block fw-medium">{{ item.product.name }}</span>
                                    <small class="text-muted">Qty: {{ item.quantity }}</small>
                                </div>
                                <span class="fw-bold">₹{{ item.total_price }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        <hr class="my-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">Subtotal</span>
                            <span class="fw-bold">₹{{ cart.total_price }}</span>
                        </div>
                    </div>

                    <!-- Delivery Charges Section -->
                    <div class="mb-4">
                        <h6 class="text-muted text-uppercase small fw-bold mb-3">[ Delivery Charges ]</h6>

                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Estimated Distance:</span>
                            <span id="distDisplay" class="fw-bold">--</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Estimated Delivery Charge:</span>
                            <span id="deliveryChargeDisplay" class="fw-bold">--</span>
                        </div>

                        <!-- Free Delivery Badge (Hidden by default, shown via JS) -->
                        <div id="freeDeliveryBadge" class="alert alert-success d-flex align-items-center p-2 mb-2"
                            style="display: none;">
                            <i class="fas fa-check-circle me-2"></i>
                            <div>
                                <strong class="d-block">Free Delivery Applied</strong>
                                <small>One-Time Offer (Within 3 KM)</small>
                            </div>
                        </div>

                        <!-- Not Eligible Notice (Hidden by default, shown via JS) -->
                        <div id="notEligibleNotice" class="alert alert-info d-flex align-items-center p-2 mb-2"
                            style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <div>
                                <small id="notEligibleReason" class="text-muted"></small>
                            </div>
                        </div>

                        <div class="alert alert-warning d-flex p-2 mt-3 mb-0 small">
                            <i class="fas fa-exclamation-triangle mt-1 me-2 text-warning"></i>
                            <div class="text-muted fst-italic">
                                Distance and delivery charges shown are approximate. We will contact you soon to confirm
                                final charges.
                            </div>
                        </div>
                    </div>

                    <!-- Total -->
                    <div class="border-top pt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="h5 mb-0">Total Pay:</span>
                            <span id="totalDisplay" class="h5 mb-0 fw-bold text-primary">₹{{ cart.total_price }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .hover-lift:hover {
        transform: translateY(-2px);
        box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15) !important;
    }
</style>

<script
    src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_PLACES_API_KEY }}&libraries=places&callback=initAutocomplete"
    async defer></script>

<script>
    const isFirstOrder = {{ is_first_order| yesno:"true,false"}};
    const cartTotal = {{ cart.total_price }};
    const SHOP_LAT = 22.7624113;
    const SHOP_LNG = 75.8692938;

    let autocomplete = null;
    let selectedPlace = null;
    let map = null;
    let marker = null;
    let shopMarker = null;
    let accuracyCircle = null;
    let currentGpsAccuracy = null;
    let distanceMatrixService = null;

    // Initialize Google Places Autocomplete
    function initAutocomplete() {
        const input = document.getElementById('addressAutocomplete');

        if (!input) {
            console.error('Address autocomplete input not found');
            return;
        }

        // Restrict to Indore, India
        const options = {
            componentRestrictions: { country: 'in' },
            bounds: {
                north: 23.0,
                south: 22.5,
                east: 76.2,
                west: 75.5
            },
            strictBounds: true,
            fields: ['formatted_address', 'geometry', 'address_components', 'name']
        };

        autocomplete = new google.maps.places.Autocomplete(input, options);
        autocomplete.addListener('place_changed', onPlaceSelected);

        console.log('Google Places Autocomplete initialized');
    }

    // When user selects a place from autocomplete
    function onPlaceSelected() {
        const place = autocomplete.getPlace();

        if (!place.geometry) {
            showMessage('error', 'Please select a valid address from the dropdown suggestions');
            return;
        }

        selectedPlace = place;

        const lat = place.geometry.location.lat();
        const lng = place.geometry.location.lng();
        const address = place.formatted_address;

        // Extract pincode, area, city
        let pincode = '';
        let area = '';
        let city = 'Indore';
        let road = '';
        let houseNumber = '';

        place.address_components.forEach(component => {
            if (component.types.includes('postal_code')) {
                pincode = component.long_name;
            }
            if (component.types.includes('sublocality_level_1') ||
                component.types.includes('sublocality')) {
                area = component.long_name;
            }
            if (component.types.includes('locality')) {
                city = component.long_name;
            }
            if (component.types.includes('route')) {
                road = component.long_name;
            }
            if (component.types.includes('street_number')) {
                houseNumber = component.long_name;
            }
        });

        // Validate pincode (Indore: 452xxx or 453xxx)
        if (pincode && !pincode.startsWith('452') && !pincode.startsWith('453')) {
            showMessage('error', 'Service available only in Indore. Selected pincode: ' + pincode);
            document.getElementById('addressAutocomplete').value = '';
            return;
        }

        // Calculate distance and update UI
        processLocation(lat, lng, address, area, city, pincode, road, houseNumber, 'PLACES');
    }

    // GPS Assist Button (matches appointment page)
    document.addEventListener('DOMContentLoaded', function () {
        const gpsBtn = document.getElementById('detectLocationBtn');
        if (gpsBtn) {
            gpsBtn.addEventListener('click', useGpsLocation);
        }

        // Hide pricing badges initially
        document.getElementById('freeDeliveryBadge').style.display = 'none';
        document.getElementById('notEligibleNotice').style.display = 'none';
        updatePricingUI(0);
    });

    function useGpsLocation() {
        if (!navigator.geolocation) {
            showMessage('error', 'GPS not supported on this device. Please use the address search box above.');
            return;
        }

        const btn = document.getElementById('detectLocationBtn');
        const msgDiv = document.getElementById('locationMsg');

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Getting high-precision location...';
        msgDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Requesting high-accuracy GPS...';
        msgDiv.className = 'form-text text-info fw-bold';

        const gpsOptions = {
            enableHighAccuracy: true,  // Request GPS (not WiFi/cell tower)
            timeout: 10000,            // 10 seconds timeout
            maximumAge: 0              // No cached location
        };

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy; // meters

                // Store GPS accuracy
                currentGpsAccuracy = accuracy;

                // Show accuracy feedback
                if (accuracy > 100) {
                    showMessage('warning', `GPS accuracy: ±${Math.round(accuracy)}m - Please verify address carefully`);
                } else if (accuracy > 50) {
                    showMessage('success', `GPS accuracy: ±${Math.round(accuracy)}m - Good precision`);
                } else {
                    showMessage('success', `GPS accuracy: ±${Math.round(accuracy)}m - Excellent precision!`);
                }

                // Reverse geocode using Google Geocoding API
                const geocoder = new google.maps.Geocoder();
                const latlng = { lat: lat, lng: lng };

                geocoder.geocode({ location: latlng }, (results, status) => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-crosshairs me-1"></i> Auto-fill Address using GPS';

                    if (status === 'OK' && results[0]) {
                        // Pre-fill autocomplete
                        document.getElementById('addressAutocomplete').value = results[0].formatted_address;

                        // Extract address components
                        let pincode = '';
                        let area = '';
                        let city = 'Indore';
                        let road = '';
                        let houseNumber = '';

                        results[0].address_components.forEach(component => {
                            if (component.types.includes('postal_code')) {
                                pincode = component.long_name;
                            }
                            if (component.types.includes('sublocality_level_1') ||
                                component.types.includes('sublocality')) {
                                area = component.long_name;
                            }
                            if (component.types.includes('locality')) {
                                city = component.long_name;
                            }
                            if (component.types.includes('route')) {
                                road = component.long_name;
                            }
                            if (component.types.includes('street_number')) {
                                houseNumber = component.long_name;
                            }
                        });

                        // Validate if location is in Indore service area
                        if (pincode && !pincode.startsWith('452') && !pincode.startsWith('453')) {
                            msgDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Location outside Indore service area. Please use address search for Indore locations.';
                            msgDiv.className = 'form-text text-danger fw-bold';
                            return;
                        }

                        processLocation(lat, lng, results[0].formatted_address, area, city, pincode, road, houseNumber, 'GPS');
                        msgDiv.innerHTML = '<i class="fas fa-check-circle"></i> Location detected successfully!';
                        msgDiv.className = 'form-text text-success fw-bold';
                    } else {
                        msgDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Could not determine address from GPS. Please use the search box above.';
                        msgDiv.className = 'form-text text-warning fw-bold';
                    }
                });
            },
            (error) => {
                const btn = document.getElementById('detectLocationBtn');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-crosshairs me-1"></i> Auto-fill Address using GPS';

                const msgDiv = document.getElementById('locationMsg');
                msgDiv.innerHTML = '<i class="fas fa-info-circle"></i> GPS permission denied. Please use the address search box above.';
                msgDiv.className = 'form-text text-muted fw-bold';
            },
            gpsOptions  // Use high-accuracy GPS settings
        );
    }

    // Process location data and calculate distance
    function processLocation(lat, lng, fullAddress, area, city, pincode, road, houseNumber, source) {
        // Store in hidden fields
        document.getElementById('id_latitude').value = lat;
        document.getElementById('id_longitude').value = lng;

        console.log('Processing location:', lat, lng, 'via', source);

        // Auto-fill address fields
        if (houseNumber) document.getElementById('id_house_number').value = houseNumber;
        if (road) document.getElementById('id_address_line1').value = road;
        if (area) document.getElementById('id_address_line2').value = area;
        if (pincode) document.getElementById('id_pincode').value = pincode;
        if (city) document.getElementById('id_city').value = city;

        // Try to match area to dropdown
        if (area) {
            const areaSelect = document.getElementById('id_area');
            let matched = false;

            // Try exact match first
            for (let i = 0; i < areaSelect.options.length; i++) {
                if (areaSelect.options[i].value === area ||
                    areaSelect.options[i].text.toLowerCase() === area.toLowerCase()) {
                    areaSelect.selectedIndex = i;
                    matched = true;
                    break;
                }
            }

            // If no exact match, try partial match
            if (!matched) {
                for (let i = 0; i < areaSelect.options.length; i++) {
                    const optionText = areaSelect.options[i].text.toLowerCase();
                    const areaLower = area.toLowerCase();
                    if (optionText.includes(areaLower) || areaLower.includes(optionText)) {
                        areaSelect.selectedIndex = i;
                        matched = true;
                        break;
                    }
                }
            }

            // If still no match, select "Other" and fill other_area
            if (!matched) {
                areaSelect.value = 'Other';
                document.getElementById('id_other_area').value = area;
                document.getElementById('id_other_area').style.display = 'block';
            }
        }

        // Show location on map
        showLocationOnMap(lat, lng, fullAddress);

        // Calculate road distance using Distance Matrix API
        calculateRoadDistance(lat, lng);
    }

    //Calculate accurate road distance using Distance Matrix API
    function calculateRoadDistance(userLat, userLng) {
        if (!distanceMatrixService) {
            distanceMatrixService = new google.maps.DistanceMatrixService();
        }

        const shopLocation = new google.maps.LatLng(SHOP_LAT, SHOP_LNG);
        const userLocation = new google.maps.LatLng(userLat, userLng);

        showMessage('info', 'Calculating precise road distance...');

        distanceMatrixService.getDistanceMatrix({
            origins: [shopLocation],
            destinations: [userLocation],
            travelMode: google.maps.TravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.METRIC,
            avoidHighways: false,
            avoidTolls: false
        }, (response, status) => {
            if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                const element = response.rows[0].elements[0];
                const distanceKm = element.distance.value / 1000; // meters to km
                const duration = element.duration.text;

                document.getElementById('id_distance_km').value = distanceKm.toFixed(2);

                console.log(`✓ Road distance: ${distanceKm.toFixed(2)} km, ETA: ${duration}`);
                showMessage('success', `Distance: ${element.distance.text}, Delivery ETA: ${duration}`);

                // Update pricing UI
                updatePricingUI(distanceKm);

                // Run verification
                performLocationVerification(userLat, userLng, distanceKm);
            } else {
                // Fallback to Haversine if Distance Matrix API fails
                console.warn('Distance Matrix API failed, using Haversine fallback');
                const straightDist = haversineDistance(SHOP_LAT, SHOP_LNG, userLat, userLng);
                document.getElementById('id_distance_km').value = straightDist.toFixed(2);

                showMessage('warning', 'Using approximate straight-line distance. Actual delivery distance may vary.');
                updatePricingUI(straightDist);

                performLocationVerification(userLat, userLng, straightDist);
            }
        });
    }

    // Show location on interactive map
    function showLocationOnMap(lat, lng, address) {
        const mapContainer = document.getElementById('mapContainer');
        const mapSection = document.getElementById('mapSection');
        mapSection.style.display = 'block';

        // Initialize map if not already done
        if (!map) {
            map = new google.maps.Map(mapContainer, {
                zoom: 15,
                center: { lat: lat, lng: lng },
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: true,
                zoomControl: true
            });

            // Add shop marker (blue)
            shopMarker = new google.maps.Marker({
                position: { lat: SHOP_LAT, lng: SHOP_LNG },
                map: map,
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                },
                title: 'Shiv Shakti Electricals (Shop Location)'
            });

            // Add delivery range circle (7 KM)
            new google.maps.Circle({
                map: map,
                center: { lat: SHOP_LAT, lng: SHOP_LNG },
                radius: 7000, // 7 KM
                fillColor: '#4CAF50',
                fillOpacity: 0.08,
                strokeColor: '#4CAF50',
                strokeOpacity: 0.4,
                strokeWeight: 2
            });
        } else {
            map.setCenter({ lat: lat, lng: lng });
        }

        // Add/update customer marker (red, draggable)
        if (marker) {
            marker.setPosition({ lat: lat, lng: lng });
        } else {
            marker = new google.maps.Marker({
                position: { lat: lat, lng: lng },
                map: map,
                draggable: true,
                animation: google.maps.Animation.DROP,
                title: 'Your Delivery Location (Drag to adjust)'
            });

            // Update when marker is dragged
            marker.addListener('dragend', (event) => {
                const newLat = event.latLng.lat();
                const newLng = event.latLng.lng();

                // Reverse geocode new position
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: { lat: newLat, lng: newLng } }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        document.getElementById('addressAutocomplete').value = results[0].formatted_address;

                        // Extract components and reprocess
                        let pincode = '', area = '', city = 'Indore', road = '', houseNumber = '';
                        results[0].address_components.forEach(component => {
                            if (component.types.includes('postal_code')) pincode = component.long_name;
                            if (component.types.includes('sublocality_level_1') || component.types.includes('sublocality')) area = component.long_name;
                            if (component.types.includes('locality')) city = component.long_name;
                            if (component.types.includes('route')) road = component.long_name;
                            if (component.types.includes('street_number')) houseNumber = component.long_name;
                        });

                        processLocation(newLat, newLng, results[0].formatted_address, area, city, pincode, road, houseNumber, 'MAP_DRAG');
                    }
                });
            });
        }

        // Show GPS accuracy circle if available
        if (currentGpsAccuracy) {
            if (accuracyCircle) {
                accuracyCircle.setMap(null);
            }
            accuracyCircle = new google.maps.Circle({
                map: map,
                center: { lat: lat, lng: lng },
                radius: currentGpsAccuracy,
                fillColor: '#FF5722',
                fillOpacity: 0.1,
                strokeColor: '#FF5722',
                strokeOpacity: 0.3,
                strokeWeight: 1
            });
        }
    }

    // Perform address verification
    function performLocationVerification(lat, lng, distKm) {
        const checks = {
            gpsAccuracy: currentGpsAccuracy ? currentGpsAccuracy <= 50 : false,
            roadDistanceOK: distKm <= 7,
            pincodeValid: false,
            withinServiceArea: false,
            addressComplete: false
        };

        // Check pincode
        const pincode = document.getElementById('id_pincode').value;
        if (pincode && (pincode.startsWith('452') || pincode.startsWith('453'))) {
            checks.pincodeValid = true;
            checks.withinServiceArea = true;
        }

        // Check address completeness
        const house = document.getElementById('id_house_number').value;
        const line1 = document.getElementById('id_address_line1').value;
        if (house && line1 && pincode) {
            checks.addressComplete = true;
        }

        // Calculate confidence score
        const totalChecks = Object.keys(checks).length;
        const passedChecks = Object.values(checks).filter(v => v).length;
        const confidence = (passedChecks / totalChecks) * 100;

        displayVerificationStatus(checks, confidence);
    }

    // Display verification status
    function displayVerificationStatus(checks, confidence) {
        const statusDiv = document.getElementById('verificationStatus');
        const bar = document.getElementById('confidenceBar');
        const details = document.getElementById('verificationDetails');

        statusDiv.style.display = 'block';

        // Update progress bar
        bar.style.width = confidence + '%';
        bar.textContent = Math.round(confidence) + '% Verified';

        if (confidence >= 80) {
            bar.className = 'progress-bar bg-success progress-bar-striped progress-bar-animated';
            statusDiv.className = 'alert alert-success mb-3';
        } else if (confidence >= 60) {
            bar.className = 'progress-bar bg-warning progress-bar-striped progress-bar-animated';
            statusDiv.className = 'alert alert-warning mb-3';
        } else {
            bar.className = 'progress-bar bg-danger progress-bar-striped progress-bar-animated';
            statusDiv.className = 'alert alert-danger mb-3';
        }

        // Show verification details
        let detailsHTML = '<ul class="mb-0 small ps-3">';
        detailsHTML += `<li>${checks.gpsAccuracy ? '✓' : '✗'} GPS Accuracy ${currentGpsAccuracy ? `(±${Math.round(currentGpsAccuracy)}m)` : ''}</li>`;
        detailsHTML += `<li>${checks.roadDistanceOK ? '✓' : '✗'} Within Delivery Range (≤7 KM)</li>`;
        detailsHTML += `<li>${checks.pincodeValid ? '✓' : '✗'} Valid Indore Pincode</li>`;
        detailsHTML += `<li>${checks.withinServiceArea ? '✓' : '✗'} Service Area Confirmed</li>`;
        detailsHTML += `<li>${checks.addressComplete ? '✓' : '✗'} Address Complete</li>`;
        detailsHTML += '</ul>';

        details.innerHTML = detailsHTML;
    }

    // Haversine distance calculation
    function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth radius in km
        const dLat = deg2rad(lat2 - lat1);
        const dLon = deg2rad(lon2 - lon1);
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function deg2rad(deg) {
        return deg * (Math.PI / 180);
    }

    // Show user-friendly messages
    function showMessage(type, message) {
        const msgDiv = document.getElementById('locationMsg');
        const icons = {
            'success': 'fa-check-circle',
            'error': 'fa-times-circle',
            'warning': 'fa-exclamation-triangle',
            'info': 'fa-spinner fa-spin'
        };
        const classes = {
            'success': 'text-success',
            'error': 'text-danger',
            'warning': 'text-warning',
            'info': 'text-info'
        };

        msgDiv.innerHTML = `<i class="fas ${icons[type] || 'fa-info-circle'}"></i> ${message}`;
        msgDiv.className = `form-text small mt-2 fw-bold ${classes[type] || 'text-muted'}`;
    }

    // Toggle other area field
    function toggleOtherArea(select) {
        const otherWrapper = document.getElementById('otherAreaWrapper');
        const otherInput = document.getElementById('id_other_area');
        if (select.value === 'Other') {
            otherWrapper.style.display = 'block';
            otherInput.style.display = 'block';
            otherInput.required = true;
        } else {
            otherWrapper.style.display = 'none';
            otherInput.style.display = 'none';
            otherInput.required = false;
            otherInput.value = '';
        }
    }

    // Update pricing UI
    function updatePricingUI(distKm, isError = false) {
        let charge = 0;
        let total = parseFloat(cartTotal);

        const distDisplay = document.getElementById('distDisplay');
        const chargeDisplay = document.getElementById('deliveryChargeDisplay');
        const totalDisplay = document.getElementById('totalDisplay');
        const freeBadge = document.getElementById('freeDeliveryBadge');
        const notEligibleNotice = document.getElementById('notEligibleNotice');
        const notEligibleReason = document.getElementById('notEligibleReason');

        // Hide all notices initially
        freeBadge.style.display = 'none';
        notEligibleNotice.style.display = 'none';

        if (isError || !distKm) {
            distDisplay.innerText = "--";
            chargeDisplay.innerText = "To be confirmed";
            totalDisplay.innerHTML = "₹" + total.toFixed(2) + " + <span class='small text-muted'>Delivery</span>";
            return;
        }

        distDisplay.innerText = "~" + distKm + " KM";

        // Delivery charge logic: 0-3: 50, 3-5: 70, 5-7: 80, >7: Out
        if (distKm <= 3.0) {
            charge = 50;
        } else if (distKm <= 5.0) {
            charge = 70;
        } else if (distKm <= 7.0) {
            charge = 80;
        } else {
            // Out of range
            chargeDisplay.innerText = "Admin Review";
            chargeDisplay.className = "fw-bold text-danger";
            totalDisplay.innerText = "₹" + total.toFixed(2) + " + Custom Charges";
            return;
        }

        // Apply Free Delivery Logic - ONLY if first order AND distance <= 3 KM
        if (isFirstOrder && distKm <= 3.0) {
            chargeDisplay.innerHTML = `<span class="text-secondary text-decoration-line-through me-2">₹${charge}</span> <span class="text-success fw-bold">FREE</span>`;
            freeBadge.style.display = 'flex';
            charge = 0;
        } else {
            chargeDisplay.innerText = "₹" + charge;
            chargeDisplay.className = "fw-bold";

            // Show reason for ineligibility
            if (isFirstOrder && distKm > 3.0) {
                notEligibleReason.innerText = "Free delivery is only available within 3 KM range.";
                notEligibleNotice.style.display = 'flex';
            } else if (!isFirstOrder) {
                notEligibleReason.innerText = "You have already used your one-time free delivery offer.";
                notEligibleNotice.style.display = 'flex';
            }
        }

        total += charge;
        totalDisplay.innerText = "₹" + total.toFixed(2);
    }

    // Form validation before submission
    document.getElementById('checkoutForm').addEventListener('submit', function (e) {
        const lat = document.getElementById('id_latitude').value;
        const lng = document.getElementById('id_longitude').value;

        if (!lat || !lng) {
            e.preventDefault();
            alert('Please select your delivery address using the search box above');
            return false;
        }
    });
</script>
{% endblock %}