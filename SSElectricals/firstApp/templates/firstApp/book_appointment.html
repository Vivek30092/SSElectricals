{% extends 'firstApp/base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                <div
                    class="card-header bg-gradient bg-warning text-dark p-4 d-flex align-items-center justify-content-between">
                    <h2 class="mb-0 fw-bold h3"><i class="fas fa-calendar-check me-2"></i>Book a Service</h2>
                    <span class="badge bg-dark text-warning fs-6 rounded-pill px-3 py-2">Quick & Reliable</span>
                </div>
                <div class="card-body p-5 bg-light">

                    <form method="post" novalidate id="bookingForm">
                        {% csrf_token %}
                        {{ form.visiting_charge }}

                        {% if form.non_field_errors %}
                        <div class="alert alert-danger rounded-3 shadow-sm">
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="row g-4">
                            <!-- Left Column: Customer & Address -->
                            <div class="col-md-6">
                                <div class="bg-white p-4 rounded-3 shadow-sm h-100">
                                    <h5 class="mb-3 text-primary border-bottom pb-2"><i
                                            class="fas fa-user me-2"></i>Customer Details</h5>
                                    <div class="mb-3">
                                        <label for="{{ form.customer_name.id_for_label }}"
                                            class="form-label fw-semibold">Full Name</label>
                                        {{ form.customer_name }}
                                        {% if form.customer_name.errors %}
                                        <div class="text-danger small mt-1">{{ form.customer_name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="mb-3">
                                        <label for="{{ form.phone.id_for_label }}" class="form-label fw-semibold">Phone
                                            Number</label>
                                        {{ form.phone }}
                                        {% if form.phone.errors %}
                                        <div class="text-danger small mt-1">{{ form.phone.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="mb-3">
                                        <label for="{{ form.email.id_for_label }}" class="form-label fw-semibold">Email
                                            Address</label>
                                        {{ form.email }}
                                        {% if form.email.errors %}
                                        <div class="text-danger small mt-1">{{ form.email.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <h5 class="mb-3 mt-4 text-primary border-bottom pb-2"><i
                                            class="fas fa-map-marker-alt me-2"></i>Location</h5>

                                    <!-- Google Places Autocomplete Search (Primary Method) -->
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Search Your Address <span
                                                class="text-danger">*</span></label>
                                        <input type="text" id="addressAutocomplete" class="form-control form-control-lg"
                                            placeholder="Start typing your address in Indore..." autocomplete="off" />
                                        <small class="form-text text-muted d-block mt-1">
                                            <i class="fas fa-info-circle"></i> Select your address from the dropdown for
                                            accurate distance calculation
                                        </small>
                                    </div>

                                    <!-- Optional GPS Assist Button -->
                                    <div class="mb-3">
                                        <button class="btn btn-outline-primary w-100 mb-2" type="button"
                                            id="detectLocationBtn">
                                            <i class="fas fa-crosshairs me-1"></i> Auto-fill Address using GPS
                                        </button>
                                        <div id="locationMsg" class="form-text small"></div>
                                    </div>

                                    <!-- Interactive Map for Location Confirmation -->
                                    <div class="mb-3" id="mapSection" style="display: none;">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-map me-1"></i> Confirm Your Location
                                        </label>
                                        <div id="mapContainer"
                                            style="height: 300px; border-radius: 8px; overflow: hidden; border: 2px solid #dee2e6;">
                                            <!--Google Map loads here -->
                                        </div>
                                        <small class="form-text text-muted d-block mt-1">
                                            <i class="fas fa-hand-pointer"></i> Drag the red marker to adjust your exact
                                            location
                                        </small>
                                    </div>

                                    <!-- Address Verification Status -->
                                    <div id="verificationStatus" class="alert alert-info mb-3" style="display:none;">
                                        <h6 class="mb-2">
                                            <i class="fas fa-shield-alt me-1"></i> Address Verification
                                        </h6>
                                        <div class="progress mb-2" style="height: 24px;">
                                            <div id="confidenceBar"
                                                class="progress-bar progress-bar-striped progress-bar-animated"
                                                role="progressbar" style="width: 0%;"></div>
                                        </div>
                                        <small id="verificationDetails" class="d-block"></small>
                                    </div>

                                    <div class="row g-2">
                                        <div class="col-4">
                                            <label for="{{ form.house_number.id_for_label }}"
                                                class="form-label small text-muted">House No.</label>
                                            {{ form.house_number }}
                                        </div>
                                        <div class="col-8">
                                            <label for="{{ form.address_line1.id_for_label }}"
                                                class="form-label small text-muted">Address Line 1</label>
                                            {{ form.address_line1 }}
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <label for="{{ form.address_line2.id_for_label }}"
                                            class="form-label small text-muted">Address Line 2 (Optional)</label>
                                        {{ form.address_line2 }}
                                    </div>
                                    <div class="row g-2 mt-1">
                                        <div class="col-6">
                                            <label for="{{ form.landmark.id_for_label }}"
                                                class="form-label small text-muted">Landmark</label>
                                            {{ form.landmark }}
                                        </div>
                                        <div class="col-6">
                                            <label for="{{ form.pincode.id_for_label }}"
                                                class="form-label small text-muted">Pincode</label>
                                            {{ form.pincode }}
                                        </div>
                                    </div>
                                    <div class="row g-2 mt-1">
                                        <div class="col-6">
                                            <label for="{{ form.city.id_for_label }}"
                                                class="form-label small text-muted">City</label>
                                            {{ form.city }}
                                        </div>
                                        <div class="col-6">
                                            <label for="{{ form.area.id_for_label }}"
                                                class="form-label small text-muted">Area</label>
                                            {{ form.area }}
                                            {{ form.other_area }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Service & Summary -->
                            <div class="col-md-6">
                                <div class="bg-white p-4 rounded-3 shadow-sm h-100 d-flex flex-column">
                                    <h5 class="mb-3 text-primary border-bottom pb-2"><i
                                            class="fas fa-tools me-2"></i>Service Request</h5>

                                    <div class="mb-3">
                                        <label for="{{ form.service_type.id_for_label }}"
                                            class="form-label fw-semibold">Select Service</label>
                                        {{ form.service_type }}
                                        {% if form.service_type.errors %}
                                        <div class="text-danger small mt-1">{{ form.service_type.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="row g-2 mb-3">
                                        <div class="col-6">
                                            <label for="{{ form.date.id_for_label }}"
                                                class="form-label fw-semibold">Date</label>
                                            {{ form.date }}
                                        </div>
                                        <div class="col-6">
                                            <label for="{{ form.time.id_for_label }}"
                                                class="form-label fw-semibold">Time</label>
                                            {{ form.time }}
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="{{ form.problem_description.id_for_label }}"
                                            class="form-label fw-semibold">Describe Issue</label>
                                        {{ form.problem_description }}
                                    </div>

                                    <!-- Cost Summary Section (Dynamic Pricing) -->
                                    <div class="mt-auto pt-4">
                                        <div id="costSummaryCard" class="card border-warning bg-warning bg-opacity-10">
                                            <div class="card-body">
                                                <h6 class="card-title fw-bold text-dark">
                                                    <i class="fas fa-file-invoice-dollar me-2"></i>Estimated Cost
                                                </h6>
                                                <div id="chargeDisplay">
                                                    <p class="mb-1 text-muted small">Select service and area to see
                                                        estimated cost.</p>
                                                    <p class="mb-0 fw-bold text-dark fs-5">₹---</p>
                                                </div>

                                                <!-- Dynamic Price Breakdown -->
                                                <div id="priceBreakdown" class="mt-3 pt-3 border-top"
                                                    style="display: none;">
                                                    <div class="d-flex justify-content-between mb-1">
                                                        <span class="text-muted small">Visiting Charge:</span>
                                                        <span id="baseChargeDisplay" class="fw-bold">₹200</span>
                                                    </div>
                                                    <div class="d-flex justify-content-between mb-1">
                                                        <span class="text-muted small">Service Charge (Est.):</span>
                                                        <span id="serviceChargeRange" class="text-muted">₹300 -
                                                            ₹1500</span>
                                                    </div>
                                                    <hr class="my-2">
                                                    <div class="d-flex justify-content-between">
                                                        <span class="fw-bold">Total Estimate:</span>
                                                        <span id="totalEstimate" class="fw-bold text-primary fs-5">₹500
                                                            - ₹1700</span>
                                                    </div>
                                                    <small class="text-muted d-block mt-2">
                                                        <i class="fas fa-info-circle"></i>
                                                        Zone: <span id="zoneDisplay">--</span>
                                                    </small>
                                                </div>

                                                <p class="mt-2 mb-0 text-muted" style="font-size: 0.75rem;">
                                                    * Final charge may vary based on actual work. Parts/material cost is
                                                    extra.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>

        <div class="d-grid gap-2 mt-4 pt-2">
            <button type="submit"
                class="btn btn-dark btn-lg py-3 rounded-3 fw-bold shadow-sm transition-all hover-lift">
                <i class="fas fa-check-circle me-2"></i>Confirm Booking
            </button>
        </div>
        </form>
    </div>
</div>
</div>
</div>
</div>

<style>
    .hover-lift:hover {
        transform: translateY(-2px);
        box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15) !important;
    }

    .transition-all {
        transition: all 0.3s ease;
    }
</style>

<script
    src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_PLACES_API_KEY }}&libraries=places&callback=initAutocomplete"
    async defer></script>

<script>
    const SHOP_LAT = 22.75981523457073;
    const SHOP_LNG = 75.86526508628523;

    let autocomplete = null;
    let selectedPlace = null;
    let map = null;
    let marker = null;
    let shopMarker = null;
    let accuracyCircle = null;
    let currentGpsAccuracy = null;
    let distanceMatrixService = null;

    // Initialize Google Places Autocomplete
    function initAutocomplete() {
        const input = document.getElementById('addressAutocomplete');

        if (!input) {
            console.error('Address autocomplete input not found');
            return;
        }

        // Restrict to Indore, India
        const options = {
            componentRestrictions: { country: 'in' },
            bounds: {
                north: 23.0,
                south: 22.5,
                east: 76.2,
                west: 75.5
            },
            strictBounds: true,
            fields: ['formatted_address', 'geometry', 'address_components', 'name']
        };

        autocomplete = new google.maps.places.Autocomplete(input, options);
        autocomplete.addListener('place_changed', onPlaceSelected);

        console.log('Google Places Autocomplete initialized');
    }

    // When user selects a place from autocomplete
    function onPlaceSelected() {
        const place = autocomplete.getPlace();

        if (!place.geometry) {
            showMessage('error', 'Please select a valid address from the dropdown suggestions');
            return;
        }

        selectedPlace = place;

        const lat = place.geometry.location.lat();
        const lng = place.geometry.location.lng();
        const address = place.formatted_address;

        // Extract pincode, area, city
        let pincode = '';
        let area = '';
        let city = 'Indore';
        let road = '';
        let houseNumber = '';

        place.address_components.forEach(component => {
            if (component.types.includes('postal_code')) {
                pincode = component.long_name;
            }
            if (component.types.includes('sublocality_level_1') ||
                component.types.includes('sublocality')) {
                area = component.long_name;
            }
            if (component.types.includes('locality')) {
                city = component.long_name;
            }
            if (component.types.includes('route')) {
                road = component.long_name;
            }
            if (component.types.includes('street_number')) {
                houseNumber = component.long_name;
            }
        });

        // Validate pincode (Indore: 452xxx or 453xxx)
        if (pincode && !pincode.startsWith('452') && !pincode.startsWith('453')) {
            showMessage('error', 'Service available only in Indore. Selected pincode: ' + pincode);
            document.getElementById('addressAutocomplete').value = '';
            return;
        }

        // Calculate distance and update UI
        processLocation(lat, lng, address, area, city, pincode, road, houseNumber, 'PLACES');
    }

    // Simple client-side validation for date (disable past dates)
    document.addEventListener('DOMContentLoaded', function () {
        var today = new Date().toISOString().split('T')[0];
        var dateInput = document.querySelector('input[type="date"]');
        if (dateInput) {
            dateInput.setAttribute('min', today);
        }

        // Initialize other area visibility
        var areaSelect = document.getElementById('id_area');
        if (areaSelect) toggleOtherArea(areaSelect);

        // Check if profile data is present and locked
        var pincodeInput = document.getElementById('id_pincode');
        var detectBtn = document.getElementById('detectLocationBtn');
        if (pincodeInput && pincodeInput.hasAttribute('readonly')) {
            if (detectBtn) {
                // Do NOT disable the button, just update text to indicate it's for cost calculation
                detectBtn.innerHTML = '<i class="fas fa-calculator me-1"></i> Calculate Visiting Charge';
                detectBtn.title = "Address is locked. Click to calculate visiting charge based on current location.";
                detectBtn.classList.remove('btn-outline-primary');
                detectBtn.classList.add('btn-outline-success');
            }
        }

        // Add listeners for dynamic pricing
        var serviceSelect = document.getElementById('id_service_type');
        var areaSelectElem = document.getElementById('id_area');

        if (serviceSelect) {
            serviceSelect.addEventListener('change', fetchServicePrice);
        }
        if (areaSelectElem) {
            areaSelectElem.addEventListener('change', function () {
                toggleOtherArea(this);
                fetchServicePrice();
            });
        }

        // Initial price fetch if both are already selected
        if (serviceSelect && serviceSelect.value && areaSelectElem && areaSelectElem.value) {
            fetchServicePrice();
        }
    });

    // Fetch service price from API
    function fetchServicePrice() {
        var serviceType = document.getElementById('id_service_type').value;
        var area = document.getElementById('id_area').value;

        if (!serviceType || !area) {
            return;
        }

        // Show loading
        var breakdown = document.getElementById('priceBreakdown');
        var chargeDisplay = document.getElementById('chargeDisplay');
        chargeDisplay.innerHTML = '<p class="mb-1 text-info small"><i class="fas fa-spinner fa-spin"></i> Fetching price...</p>';

        fetch('/api/service-price/?service_type=' + encodeURIComponent(serviceType) + '&area=' + encodeURIComponent(area))
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updatePriceDisplay(data);
                } else {
                    chargeDisplay.innerHTML = '<p class="mb-1 text-muted small">Price information unavailable.</p>';
                    breakdown.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Price fetch error:', error);
                chargeDisplay.innerHTML = '<p class="mb-1 text-muted small">Select service and area for pricing.</p>';
            });
    }

    // Update price display with API data
    function updatePriceDisplay(data) {
        var chargeDisplay = document.getElementById('chargeDisplay');
        var breakdown = document.getElementById('priceBreakdown');
        var card = document.getElementById('costSummaryCard');

        // Show service type info
        chargeDisplay.innerHTML = `
            <p class="mb-1 text-success fw-semibold">${data.service_type}</p>
            <p class="mb-0 text-muted small">in ${data.area}</p>
        `;

        // Update breakdown
        document.getElementById('baseChargeDisplay').textContent = '₹' + data.base_price;
        document.getElementById('serviceChargeRange').textContent = '₹' + data.min_service_charge + ' - ₹' + data.max_service_charge;

        var totalMin = data.base_price + data.min_service_charge;
        var totalMax = data.base_price + data.max_service_charge;
        document.getElementById('totalEstimate').textContent = '₹' + totalMin + ' - ₹' + totalMax;
        document.getElementById('zoneDisplay').textContent = data.zone_display;

        // Show breakdown
        breakdown.style.display = 'block';
        card.className = 'card border-success bg-success bg-opacity-10';

        // Update hidden visiting charge field
        var chargeInput = document.getElementById('id_visiting_charge');
        if (chargeInput) {
            chargeInput.value = data.base_price;
        }
    }

    // GPS Assist Button
    document.getElementById('detectLocationBtn').addEventListener('click', useGpsLocation);

    function useGpsLocation() {
        if (!navigator.geolocation) {
            showMessage('error', 'GPS not supported on this device. Please use the address search box above.');
            return;
        }

        const btn = document.getElementById('detectLocationBtn');
        const msgDiv = document.getElementById('locationMsg');

        if (btn.disabled) return;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Getting high-precision location...';
        msgDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Requesting high-accuracy GPS...';
        msgDiv.className = 'form-text text-info fw-bold';

        const gpsOptions = {
            enableHighAccuracy: true,  // Request GPS (not WiFi/cell tower)
            timeout: 10000,            // 10 seconds timeout
            maximumAge: 0              // No cached location
        };

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy; // meters

                // Store GPS accuracy
                currentGpsAccuracy = accuracy;

                // Show accuracy feedback
                if (accuracy > 100) {
                    showMessage('warning', `GPS accuracy: ±${Math.round(accuracy)}m - Please verify address carefully`);
                } else if (accuracy > 50) {
                    showMessage('success', `GPS accuracy: ±${Math.round(accuracy)}m - Good precision`);
                } else {
                    showMessage('success', `GPS accuracy: ±${Math.round(accuracy)}m - Excellent precision!`);
                }

                // Reverse geocode using Google Geocoding API
                const geocoder = new google.maps.Geocoder();
                const latlng = { lat: lat, lng: lng };

                geocoder.geocode({ location: latlng }, (results, status) => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-crosshairs me-1"></i> Auto-fill Address using GPS';

                    if (status === 'OK' && results[0]) {
                        // Pre-fill autocomplete
                        document.getElementById('addressAutocomplete').value = results[0].formatted_address;

                        // Extract address components
                        let pincode = '';
                        let area = '';
                        let city = 'Indore';
                        let road = '';
                        let houseNumber = '';

                        results[0].address_components.forEach(component => {
                            if (component.types.includes('postal_code')) {
                                pincode = component.long_name;
                            }
                            if (component.types.includes('sublocality_level_1') ||
                                component.types.includes('sublocality')) {
                                area = component.long_name;
                            }
                            if (component.types.includes('locality')) {
                                city = component.long_name;
                            }
                            if (component.types.includes('route')) {
                                road = component.long_name;
                            }
                            if (component.types.includes('street_number')) {
                                houseNumber = component.long_name;
                            }
                        });

                        // Validate if location is in Indore service area
                        if (pincode && !pincode.startsWith('452') && !pincode.startsWith('453')) {
                            msgDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Location outside Indore service area. Please use address search for Indore locations.';
                            msgDiv.className = 'form-text text-danger fw-bold';
                            return;
                        }

                        processLocation(lat, lng, results[0].formatted_address, area, city, pincode, road, houseNumber, 'GPS');
                        msgDiv.innerHTML = '<i class="fas fa-check-circle"></i> Location detected successfully!';
                        msgDiv.className = 'form-text text-success fw-bold';
                    } else {
                        msgDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Could not determine address from GPS. Please use the search box above.';
                        msgDiv.className = 'form-text text-warning fw-bold';
                    }
                });
            },
            (error) => {
                const btn = document.getElementById('detectLocationBtn');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-crosshairs me-1"></i> Auto-fill Address using GPS';

                const msgDiv = document.getElementById('locationMsg');
                msgDiv.innerHTML = '<i class="fas fa-info-circle"></i> GPS permission denied. Please use the address search box above.';
                msgDiv.className = 'form-text text-muted fw-bold';
            },
            gpsOptions  // Use high-accuracy GPS settings
        );
    }

    // Process location data and calculate distance
    function processLocation(lat, lng, fullAddress, area, city, pincode, road, houseNumber, source) {
        console.log('Processing location:', lat, lng, 'via', source);

        // Auto-fill address fields
        if (houseNumber) document.getElementById('id_house_number').value = houseNumber;
        if (road) document.getElementById('id_address_line1').value = road;
        if (area) document.getElementById('id_address_line2').value = area;
        if (pincode) document.getElementById('id_pincode').value = pincode;
        if (city) document.getElementById('id_city').value = city;

        // Try to match area to dropdown
        if (area) {
            const areaSelect = document.getElementById('id_area');
            let matched = false;

            // Try exact match first
            for (let i = 0; i < areaSelect.options.length; i++) {
                if (areaSelect.options[i].value === area ||
                    areaSelect.options[i].text.toLowerCase() === area.toLowerCase()) {
                    areaSelect.selectedIndex = i;
                    matched = true;
                    break;
                }
            }

            // If no exact match, try partial match
            if (!matched) {
                for (let i = 0; i < areaSelect.options.length; i++) {
                    const optionText = areaSelect.options[i].text.toLowerCase();
                    const areaLower = area.toLowerCase();
                    if (optionText.includes(areaLower) || areaLower.includes(optionText)) {
                        areaSelect.selectedIndex = i;
                        matched = true;
                        break;
                    }
                }
            }

            // If still no match, select "Other" and fill other_area
            if (!matched) {
                areaSelect.value = 'Other';
                document.getElementById('id_other_area').value = area;
                document.getElementById('id_other_area').style.display = 'block';
            }
        }

        // Show location on map
        showLocationOnMap(lat, lng, fullAddress);

        // Calculate road distance using Distance Matrix API
        calculateRoadDistance(lat, lng);
    }

    // Calculate accurate road distance using Distance Matrix API
    function calculateRoadDistance(userLat, userLng) {
        if (!distanceMatrixService) {
            distanceMatrixService = new google.maps.DistanceMatrixService();
        }

        const shopLocation = new google.maps.LatLng(SHOP_LAT, SHOP_LNG);
        const userLocation = new google.maps.LatLng(userLat, userLng);

        showMessage('info', 'Calculating precise road distance...');

        distanceMatrixService.getDistanceMatrix({
            origins: [shopLocation],
            destinations: [userLocation],
            travelMode: google.maps.TravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.METRIC,
            avoidHighways: false,
            avoidTolls: false
        }, (response, status) => {
            if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                const element = response.rows[0].elements[0];
                const distanceKm = element.distance.value / 1000; // meters to km
                const duration = element.duration.text;

                console.log(`✓ Road distance: ${distanceKm.toFixed(2)} km, ETA: ${duration}`);
                showMessage('success', `Distance: ${element.distance.text}, Service ETA: ${duration}`);

                // Update service charge UI
                updateServiceChargeUI(distanceKm);

                // Run verification
                performLocationVerification(userLat, userLng, distanceKm);
            } else {
                // Fallback to Haversine if Distance Matrix API fails
                console.warn('Distance Matrix API failed, using Haversine fallback');
                const straightDist = haversineDistance(SHOP_LAT, SHOP_LNG, userLat, userLng);

                showMessage('warning', 'Using approximate straight-line distance. Actual distance may vary.');
                updateServiceChargeUI(straightDist);

                performLocationVerification(userLat, userLng, straightDist);
            }
        });
    }

    // Show location on interactive map
    function showLocationOnMap(lat, lng, address) {
        const mapContainer = document.getElementById('mapContainer');
        const mapSection = document.getElementById('mapSection');
        mapSection.style.display = 'block';

        // Initialize map if not already done
        if (!map) {
            map = new google.maps.Map(mapContainer, {
                zoom: 15,
                center: { lat: lat, lng: lng },
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: true,
                zoomControl: true
            });

            // Add shop marker (blue)
            shopMarker = new google.maps.Marker({
                position: { lat: SHOP_LAT, lng: SHOP_LNG },
                map: map,
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                },
                title: 'Shiv Shakti Electricals (Shop Location)'
            });

            // Add service range circle (7 KM)
            new google.maps.Circle({
                map: map,
                center: { lat: SHOP_LAT, lng: SHOP_LNG },
                radius: 7000, // 7 KM
                fillColor: '#FFC107',
                fillOpacity: 0.08,
                strokeColor: '#FFC107',
                strokeOpacity: 0.4,
                strokeWeight: 2
            });
        } else {
            map.setCenter({ lat: lat, lng: lng });
        }

        // Add/update customer marker (red, draggable)
        if (marker) {
            marker.setPosition({ lat: lat, lng: lng });
        } else {
            marker = new google.maps.Marker({
                position: { lat: lat, lng: lng },
                map: map,
                draggable: true,
                animation: google.maps.Animation.DROP,
                title: 'Your Service Location (Drag to adjust)'
            });

            // Update when marker is dragged
            marker.addListener('dragend', (event) => {
                const newLat = event.latLng.lat();
                const newLng = event.latLng.lng();

                // Reverse geocode new position
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: { lat: newLat, lng: newLng } }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        document.getElementById('addressAutocomplete').value = results[0].formatted_address;

                        // Extract components and reprocess
                        let pincode = '', area = '', city = 'Indore', road = '', houseNumber = '';
                        results[0].address_components.forEach(component => {
                            if (component.types.includes('postal_code')) pincode = component.long_name;
                            if (component.types.includes('sublocality_level_1') || component.types.includes('sublocality')) area = component.long_name;
                            if (component.types.includes('locality')) city = component.long_name;
                            if (component.types.includes('route')) road = component.long_name;
                            if (component.types.includes('street_number')) houseNumber = component.long_name;
                        });

                        processLocation(newLat, newLng, results[0].formatted_address, area, city, pincode, road, houseNumber, 'MAP_DRAG');
                    }
                });
            });
        }

        // Show GPS accuracy circle if available
        if (currentGpsAccuracy) {
            if (accuracyCircle) {
                accuracyCircle.setMap(null);
            }
            accuracyCircle = new google.maps.Circle({
                map: map,
                center: { lat: lat, lng: lng },
                radius: currentGpsAccuracy,
                fillColor: '#FF5722',
                fillOpacity: 0.1,
                strokeColor: '#FF5722',
                strokeOpacity: 0.3,
                strokeWeight: 1
            });
        }
    }

    // Perform address verification
    function performLocationVerification(lat, lng, distKm) {
        const checks = {
            gpsAccuracy: currentGpsAccuracy ? currentGpsAccuracy <= 50 : false,
            roadDistanceOK: distKm <= 7,
            pincodeValid: false,
            withinServiceArea: false,
            addressComplete: false
        };

        // Check pincode
        const pincode = document.getElementById('id_pincode').value;
        if (pincode && (pincode.startsWith('452') || pincode.startsWith('453'))) {
            checks.pincodeValid = true;
            checks.withinServiceArea = true;
        }

        // Check address completeness
        const house = document.getElementById('id_house_number').value;
        const line1 = document.getElementById('id_address_line1').value;
        if (house && line1 && pincode) {
            checks.addressComplete = true;
        }

        // Calculate confidence score
        const totalChecks = Object.keys(checks).length;
        const passedChecks = Object.values(checks).filter(v => v).length;
        const confidence = (passedChecks / totalChecks) * 100;

        displayVerificationStatus(checks, confidence);
    }

    // Display verification status
    function displayVerificationStatus(checks, confidence) {
        const statusDiv = document.getElementById('verificationStatus');
        const bar = document.getElementById('confidenceBar');
        const details = document.getElementById('verificationDetails');

        statusDiv.style.display = 'block';

        // Update progress bar
        bar.style.width = confidence + '%';
        bar.textContent = Math.round(confidence) + '% Verified';

        if (confidence >= 80) {
            bar.className = 'progress-bar bg-success progress-bar-striped progress-bar-animated';
            statusDiv.className = 'alert alert-success mb-3';
        } else if (confidence >= 60) {
            bar.className = 'progress-bar bg-warning progress-bar-striped progress-bar-animated';
            statusDiv.className = 'alert alert-warning mb-3';
        } else {
            bar.className = 'progress-bar bg-danger progress-bar-striped progress-bar-animated';
            statusDiv.className = 'alert alert-danger mb-3';
        }

        // Show verification details
        let detailsHTML = '<ul class="mb-0 small ps-3">';
        detailsHTML += `<li>${checks.gpsAccuracy ? '✓' : '✗'} GPS Accuracy ${currentGpsAccuracy ? `(±${Math.round(currentGpsAccuracy)}m)` : ''}</li>`;
        detailsHTML += `<li>${checks.roadDistanceOK ? '✓' : '✗'} Within Service Range (≤7 KM)</li>`;
        detailsHTML += `<li>${checks.pincodeValid ? '✓' : '✗'} Valid Indore Pincode</li>`;
        detailsHTML += `<li>${checks.withinServiceArea ? '✓' : '✗'} Service Area Confirmed</li>`;
        detailsHTML += `<li>${checks.addressComplete ? '✓' : '✗'} Address Complete</li>`;
        detailsHTML += '</ul>';

        details.innerHTML = detailsHTML;
    }


    // Haversine distance calculation
    function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth radius in km
        const dLat = deg2rad(lat2 - lat1);
        const dLon = deg2rad(lon2 - lon1);
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function deg2rad(deg) {
        return deg * (Math.PI / 180);
    }

    // Show user-friendly messages
    function showMessage(type, message) {
        const msgDiv = document.getElementById('locationMsg');
        const icons = {
            'success': 'fa-check-circle',
            'error': 'fa-times-circle',
            'warning': 'fa-exclamation-triangle',
            'info': 'fa-spinner fa-spin'
        };
        const classes = {
            'success': 'text-success',
            'error': 'text-danger',
            'warning': 'text-warning',
            'info': 'text-info'
        };

        msgDiv.innerHTML = `<i class="fas ${icons[type] || 'fa-info-circle'}"></i> ${message}`;
        msgDiv.className = `form-text small mt-2 fw-bold ${classes[type] || 'text-muted'}`;
    }

    function toggleOtherArea(select) {
        var otherInput = document.getElementById('id_other_area');
        if (select.value === 'Other') {
            otherInput.style.display = 'block';
            otherInput.required = true;
        } else {
            otherInput.style.display = 'none';
            otherInput.required = false;
            otherInput.value = '';
        }
    }

    function updateServiceChargeUI(distKm) {
        var chargeDisplay = document.getElementById('chargeDisplay');
        var card = document.getElementById('costSummaryCard');

        // Pricing Logic
        var charge = 0;
        var message = "";
        var isOutOfRange = false;

        if (distKm <= 3) {
            charge = 200;
            message = "Distance: " + distKm.toFixed(1) + " KM (Within 3 KM)";
        } else if (distKm > 3 && distKm <= 7) {
            charge = 250;
            message = "Distance: " + distKm.toFixed(1) + " KM (3-7 KM Range)";
        } else {
            isOutOfRange = true;
            message = "Distance: " + distKm.toFixed(1) + " KM (Out of Quick Service Range)";
        }

        // Update hidden field
        var chargeInput = document.getElementById('id_visiting_charge');
        if (chargeInput) {
            chargeInput.value = charge;
        }

        if (isOutOfRange) {
            card.className = 'card border-danger bg-danger bg-opacity-10';
            chargeDisplay.innerHTML = `
                <p class="mb-1 text-danger fw-bold">${message}</p>
                <p class="mb-0 text-danger small">Please contact us directly for service availability.</p>
            `;
        } else {
            card.className = 'card border-success bg-success bg-opacity-10';
            chargeDisplay.innerHTML = `
                <p class="mb-1 text-success fw-bold">${message}</p>
                <div class="d-flex align-items-baseline">
                    <span class="fs-6 text-muted me-2">Visiting Charge:</span>
                    <span class="fs-3 fw-bold text-success">₹${charge}</span>
                </div>
            `;
        }
    }
</script>
{% endblock %}