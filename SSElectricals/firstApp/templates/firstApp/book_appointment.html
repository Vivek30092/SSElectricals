{% extends 'firstApp/base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                <div
                    class="card-header bg-gradient bg-warning text-dark p-4 d-flex align-items-center justify-content-between">
                    <h2 class="mb-0 fw-bold h3"><i class="fas fa-calendar-check me-2"></i>Book a Service</h2>
                    <span class="badge bg-dark text-warning fs-6 rounded-pill px-3 py-2">Quick & Reliable</span>
                </div>
                <div class="card-body p-5 bg-light">

                    <form method="post" novalidate id="bookingForm">
                        {% csrf_token %}
                        {{ form.visiting_charge }}
                        {{ form.distance_km }}
                        {{ form.location_verification }}
                        {{ form.price_calculation }}
                        {{ form.is_indore }}


                        {% if form.non_field_errors %}
                        <div class="alert alert-danger rounded-3 shadow-sm">
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="row g-4">
                            <!-- Left Column: Customer & Address -->
                            <div class="col-md-6">
                                <div class="bg-white p-4 rounded-3 shadow-sm h-100">
                                    <h5 class="mb-3 text-primary border-bottom pb-2"><i
                                            class="fas fa-user me-2"></i>Customer Details</h5>
                                    <div class="mb-3">
                                        <label for="{{ form.customer_name.id_for_label }}"
                                            class="form-label fw-semibold">Full Name</label>
                                        {{ form.customer_name }}
                                        {% if form.customer_name.errors %}
                                        <div class="text-danger small mt-1">{{ form.customer_name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="mb-3">
                                        <label for="{{ form.phone.id_for_label }}" class="form-label fw-semibold">Phone
                                            Number</label>
                                        {{ form.phone }}
                                        {% if form.phone.errors %}
                                        <div class="text-danger small mt-1">{{ form.phone.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="mb-3">
                                        <label for="{{ form.email.id_for_label }}" class="form-label fw-semibold">Email
                                            Address</label>
                                        {{ form.email }}
                                        {% if form.email.errors %}
                                        <div class="text-danger small mt-1">{{ form.email.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <h5 class="mb-3 mt-4 text-primary border-bottom pb-2"><i
                                            class="fas fa-map-marker-alt me-2"></i>Location</h5>

                                    <!-- Google Places Autocomplete Search (Primary Method) -->
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Search Your Address <span
                                                class="text-danger">*</span></label>
                                        <input type="text" id="addressAutocomplete" class="form-control form-control-lg"
                                            placeholder="Start typing your address in Indore..." autocomplete="off" />
                                        <small class="form-text text-muted d-block mt-1">
                                            <i class="fas fa-info-circle"></i> Select your address from the dropdown for
                                            accurate distance calculation
                                        </small>
                                    </div>

                                    <!-- Optional GPS Assist Button -->
                                    <div class="mb-3">
                                        <button class="btn btn-outline-primary w-100 mb-2" type="button"
                                            id="detectLocationBtn">
                                            <i class="fas fa-crosshairs me-1"></i> Auto-fill Address using GPS
                                        </button>
                                        <div id="locationMsg" class="form-text small"></div>
                                    </div>

                                    <!-- Interactive Map for Location Confirmation -->
                                    <div class="mb-3" id="mapSection" style="display: none;">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-map me-1"></i> Confirm Your Location
                                        </label>
                                        <div id="mapContainer"
                                            style="height: 300px; border-radius: 8px; overflow: hidden; border: 2px solid #dee2e6;">
                                            <!--Google Map loads here -->
                                        </div>
                                        <small class="form-text text-muted d-block mt-1">
                                            <i class="fas fa-hand-pointer"></i> Drag the red marker to adjust your exact
                                            location
                                        </small>
                                    </div>

                                    <!-- Address Verification Status -->
                                    <div id="verificationStatus" class="alert alert-info mb-3" style="display:none;">
                                        <h6 class="mb-2">
                                            <i class="fas fa-shield-alt me-1"></i> Address Verification
                                        </h6>
                                        <div class="progress mb-2" style="height: 24px;">
                                            <div id="confidenceBar"
                                                class="progress-bar progress-bar-striped progress-bar-animated"
                                                role="progressbar" style="width: 0%;"></div>
                                        </div>
                                        <small id="verificationDetails" class="d-block"></small>
                                    </div>

                                    <div class="row g-2">
                                        <div class="col-4">
                                            <label for="{{ form.house_number.id_for_label }}"
                                                class="form-label small text-muted">House No.</label>
                                            {{ form.house_number }}
                                        </div>
                                        <div class="col-8">
                                            <label for="{{ form.address_line1.id_for_label }}"
                                                class="form-label small text-muted">Address Line 1</label>
                                            {{ form.address_line1 }}
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <label for="{{ form.address_line2.id_for_label }}"
                                            class="form-label small text-muted">Address Line 2 (Optional)</label>
                                        {{ form.address_line2 }}
                                    </div>
                                    <div class="row g-2 mt-1">
                                        <div class="col-6">
                                            <label for="{{ form.landmark.id_for_label }}"
                                                class="form-label small text-muted">Landmark</label>
                                            {{ form.landmark }}
                                        </div>
                                        <div class="col-6">
                                            <label for="{{ form.pincode.id_for_label }}"
                                                class="form-label small text-muted">Pincode</label>
                                            {{ form.pincode }}
                                        </div>
                                    </div>
                                    <div class="row g-2 mt-1">
                                        <div class="col-6">
                                            <label for="{{ form.city.id_for_label }}"
                                                class="form-label small text-muted">City</label>
                                            {{ form.city }}
                                        </div>
                                        <div class="col-6">
                                            <label for="{{ form.area.id_for_label }}"
                                                class="form-label small text-muted">Area</label>
                                            {{ form.area }}
                                            {{ form.other_area }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Service & Summary -->
                            <div class="col-md-6">
                                <div class="bg-white p-4 rounded-3 shadow-sm h-100 d-flex flex-column">
                                    <h5 class="mb-3 text-primary border-bottom pb-2"><i
                                            class="fas fa-tools me-2"></i>Service Request</h5>

                                    <div class="mb-3">
                                        <label for="{{ form.service.id_for_label }}"
                                            class="form-label fw-semibold">Select Service</label>
                                        {{ form.service }}
                                        {% if form.service.errors %}
                                        <div class="text-danger small mt-1">{{ form.service.errors.0 }}</div>
                                        {% endif %}
                                        {% if not services_available %}
                                        <div class="alert alert-warning mt-2 small">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            No services available at the moment. Please check back later.
                                        </div>
                                        {% endif %}
                                    </div>


                                    <div class="row g-2 mb-3">
                                        <div class="col-6">
                                            <label for="{{ form.date.id_for_label }}"
                                                class="form-label fw-semibold">Date</label>
                                            {{ form.date }}
                                        </div>
                                        <div class="col-6">
                                            <label for="{{ form.time.id_for_label }}"
                                                class="form-label fw-semibold">Time</label>
                                            {{ form.time }}
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="{{ form.problem_description.id_for_label }}"
                                            class="form-label fw-semibold">Describe Issue</label>
                                        {{ form.problem_description }}
                                    </div>

                                    <!-- Cost Summary Section (Dynamic Pricing) -->
                                    <div class="mt-auto pt-4">
                                        <div id="costSummaryCard"
                                            class="card border-primary bg-primary bg-opacity-10 shadow-sm border-0 rounded-4">
                                            <div class="card-body p-4">
                                                <h6 class="card-title fw-bold text-primary mb-3">
                                                    <i class="fas fa-file-invoice-dollar me-2"></i>Estimated Cost
                                                </h6>

                                                <!-- Default message when no service/distance selected -->
                                                <div id="chargeDisplay">
                                                    <div
                                                        class="d-flex flex-column align-items-center justify-content-center py-3">
                                                        <p class="mb-2 text-muted small text-center">Select service and
                                                            provide location to see estimated cost.</p>
                                                        <div class="fs-2 fw-bold text-primary opacity-50">₹ ---</div>
                                                    </div>
                                                </div>

                                                <!-- Message when pricing requires confirmation -->
                                                <div id="confirmationMessage"
                                                    class="alert alert-info border-0 shadow-sm rounded-3 mb-0"
                                                    style="display: none;">
                                                    <div class="d-flex">
                                                        <i class="fas fa-info-circle mt-1 me-3 fs-5"></i>
                                                        <div>
                                                            <strong class="d-block mb-1">Admin Confirmation
                                                                Required</strong>
                                                            <span class="small" id="confirmationText">Estimated cost
                                                                will be confirmed. Our admin will contact you
                                                                soon.</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Dynamic Price Breakdown (for fixed pricing) -->
                                                <div id="priceBreakdown" class="bg-white rounded-3 p-3 shadow-sm"
                                                    style="display: none;">
                                                    <div class="d-flex justify-content-between mb-2">
                                                        <span class="text-muted small">Service Fee:</span>
                                                        <span id="serviceNameDisplay"
                                                            class="fw-semibold small text-truncate ms-2"
                                                            style="max-width: 150px;">--</span>
                                                    </div>
                                                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                                                        <span class="text-muted small">Distance slab:</span>
                                                        <span id="zoneDisplay"
                                                            class="badge bg-light text-dark fw-normal">--</span>
                                                    </div>
                                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                                        <span class="fw-bold text-dark">Total Estimate:</span>
                                                        <span id="totalEstimate" class="fw-bold text-primary fs-4">₹
                                                            ---</span>
                                                    </div>

                                                    <input type="text" id="readOnlyCost"
                                                        class="form-control form-control-sm bg-light mt-3 text-center fw-bold text-primary"
                                                        readonly value="Estimated Cost: ₹ ---">
                                                </div>

                                                <div
                                                    class="mt-3 p-2 bg-white bg-opacity-50 rounded-3 border-start border-4 border-warning">
                                                    <p class="mb-0 text-muted" style="font-size: 0.75rem;">
                                                        <i class="fas fa-exclamation-triangle me-1 text-warning"></i>
                                                        <strong>Note:</strong> Final charges may vary based on service
                                                        complexity or materials required.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>

        <div class="d-grid gap-2 mt-4 pt-2">
            <button type="submit"
                class="btn btn-dark btn-lg py-3 rounded-3 fw-bold shadow-sm transition-all hover-lift">
                <i class="fas fa-check-circle me-2"></i>Confirm Booking
            </button>
        </div>
        </form>
    </div>
</div>
</div>
</div>
</div>

<style>
    .hover-lift:hover {
        transform: translateY(-2px);
        box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15) !important;
    }

    .transition-all {
        transition: all 0.3s ease;
    }
</style>

<script
    src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_PLACES_API_KEY }}&libraries=places&callback=initAutocomplete"
    async defer></script>

<script>
    const SHOP_LAT = 22.75981523457073;
    const SHOP_LNG = 75.86526508628523;

    let autocomplete = null;
    let selectedPlace = null;
    let map = null;
    let marker = null;
    let shopMarker = null;
    let accuracyCircle = null;
    let currentGpsAccuracy = null;
    let distanceMatrixService = null;
    let currentDistanceKm = null;

    // --- REQUIREMENT: INDORE VALIDATION ---
    function checkIndoreLocation() {
        if (!navigator.geolocation) {
            setManualLocationStatus();
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: { lat: lat, lng: lng } }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        let city = "";
                        results[0].address_components.forEach(comp => {
                            if (comp.types.includes('locality')) city = comp.long_name;
                        });

                        const isIndore = city.toLowerCase() === 'indore';
                        document.getElementById('id_is_indore').value = isIndore ? 'True' : 'False';
                        document.getElementById('id_location_verification').value = 'GPS confirmed';

                        if (!isIndore) {
                            showOutsideIndoreWarning();
                        }
                    } else {
                        setManualLocationStatus();
                    }
                });
            },
            (error) => {
                setManualLocationStatus();
                showMessage('warning', 'We couldn’t auto-detect your location. We’ll verify it manually.');
            },
            { timeout: 5000 }
        );
    }

    function setManualLocationStatus() {
        document.getElementById('id_location_verification').value = 'Manual entry';
        document.getElementById('id_is_indore').value = 'True'; // Default to True to not block, verified manually
    }

    function showOutsideIndoreWarning() {
        const text = document.getElementById('confirmationText');
        if (text) text.textContent = "Service availability and charges will be confirmed by admin.";
        updateServiceChargeUI(currentDistanceKm);
    }

    // Initialize Page
    document.addEventListener('DOMContentLoaded', function () {
        // Attempt GPS check
        setTimeout(checkIndoreLocation, 1000);

        // Date constraints
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.querySelector('input[type="date"]');
        if (dateInput) dateInput.setAttribute('min', today);

        // Listen for service selection
        const serviceSelect = document.getElementById('id_service');
        if (serviceSelect) {
            serviceSelect.addEventListener('change', function () {
                updateServiceChargeUI(currentDistanceKm);
            });
        }
    });

    function initAutocomplete() {
        const input = document.getElementById('addressAutocomplete');
        if (!input) return;

        autocomplete = new google.maps.places.Autocomplete(input, {
            componentRestrictions: { country: 'in' },
            fields: ['formatted_address', 'geometry', 'address_components', 'name']
        });
        autocomplete.addListener('place_changed', onPlaceSelected);
    }

    function onPlaceSelected() {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;

        const lat = place.geometry.location.lat();
        const lng = place.geometry.location.lng();

        let pincode = '', area = '', city = 'Indore', road = '', houseNumber = '';
        place.address_components.forEach(component => {
            if (component.types.includes('postal_code')) pincode = component.long_name;
            if (component.types.includes('sublocality_level_1') || component.types.includes('sublocality')) area = component.long_name;
            if (component.types.includes('locality')) city = component.long_name;
            if (component.types.includes('route')) road = component.long_name;
            if (component.types.includes('street_number')) houseNumber = component.long_name;
        });

        processLocation(lat, lng, place.formatted_address, area, city, pincode, road, houseNumber, 'PLACES');
    }

    function useGpsLocation() {
        if (!navigator.geolocation) {
            showMessage('error', 'GPS not supported.');
            return;
        }

        const btn = document.getElementById('detectLocationBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Detecting...';

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                currentGpsAccuracy = position.coords.accuracy;

                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: { lat: lat, lng: lng } }, (results, status) => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-crosshairs me-1"></i> Auto-fill Address using GPS';

                    if (status === 'OK' && results[0]) {
                        document.getElementById('addressAutocomplete').value = results[0].formatted_address;
                        let pincode = '', area = '', city = 'Indore', road = '', houseNumber = '';
                        results[0].address_components.forEach(component => {
                            if (component.types.includes('postal_code')) pincode = component.long_name;
                            if (component.types.includes('sublocality_level_1') || component.types.includes('sublocality')) area = component.long_name;
                            if (component.types.includes('locality')) city = component.long_name;
                            if (component.types.includes('route')) road = component.long_name;
                            if (component.types.includes('street_number')) houseNumber = component.long_name;
                        });

                        document.getElementById('id_location_verification').value = 'GPS confirmed';
                        processLocation(lat, lng, results[0].formatted_address, area, city, pincode, road, houseNumber, 'GPS');
                        showMessage('success', 'Location detected!');
                    }
                });
            },
            () => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-crosshairs me-1"></i> Auto-fill Address using GPS';
                showMessage('warning', 'GPS failed. We’ll verify it manually.');
                document.getElementById('id_location_verification').value = 'Manual entry';
            }
        );
    }

    function processLocation(lat, lng, fullAddress, area, city, pincode, road, houseNumber, source) {
        if (houseNumber) document.getElementById('id_house_number').value = houseNumber;
        if (road) document.getElementById('id_address_line1').value = road;
        if (area) document.getElementById('id_address_line2').value = area;
        if (pincode) document.getElementById('id_pincode').value = pincode;
        if (city) document.getElementById('id_city').value = city;

        if (area) {
            const areaSelect = document.getElementById('id_area');
            let matched = false;
            for (let i = 0; i < areaSelect.options.length; i++) {
                if (areaSelect.options[i].value === area || areaSelect.options[i].text.toLowerCase().includes(area.toLowerCase())) {
                    areaSelect.selectedIndex = i;
                    matched = true;
                    break;
                }
            }
            if (!matched) {
                areaSelect.value = 'Other';
                document.getElementById('id_other_area').value = area;
                document.getElementById('id_other_area').style.display = 'block';
            }
        }

        showLocationOnMap(lat, lng, fullAddress);
        calculateRoadDistance(lat, lng);
    }

    function calculateRoadDistance(userLat, userLng) {
        if (!distanceMatrixService) distanceMatrixService = new google.maps.DistanceMatrixService();

        distanceMatrixService.getDistanceMatrix({
            origins: [new google.maps.LatLng(SHOP_LAT, SHOP_LNG)],
            destinations: [new google.maps.LatLng(userLat, userLng)],
            travelMode: google.maps.TravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.METRIC,
        }, (response, status) => {
            if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                const distKm = response.rows[0].elements[0].distance.value / 1000;
                updateServiceChargeUI(distKm);
                performLocationVerification(userLat, userLng, distKm);
            }
        });
    }

    function updateServiceChargeUI(distanceKm) {
        currentDistanceKm = distanceKm;
        const distField = document.getElementById('id_distance_km');
        if (distField) distField.value = distanceKm ? distanceKm.toFixed(2) : '';

        const serviceSelect = document.getElementById('id_service');
        const serviceVal = serviceSelect ? serviceSelect.value : null;

        const chargeDisplay = document.getElementById('chargeDisplay');
        const priceBreakdown = document.getElementById('priceBreakdown');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmationText = document.getElementById('confirmationText');
        const visitingChargeField = document.getElementById('id_visiting_charge');
        const isIndore = document.getElementById('id_is_indore').value === 'True';

        if (!serviceVal) {
            chargeDisplay.style.display = 'block';
            priceBreakdown.style.display = 'none';
            confirmationMessage.style.display = 'none';
            return;
        }

        if (serviceVal === 'other') {
            chargeDisplay.style.display = 'none';
            priceBreakdown.style.display = 'none';
            confirmationMessage.style.display = 'block';
            confirmationText.textContent = "Estimated cost will be confirmed. Our admin will contact you soon.";
            document.getElementById('id_price_calculation').value = 'Pending confirmation';
            return;
        }

        if (!isIndore) {
            chargeDisplay.style.display = 'none';
            priceBreakdown.style.display = 'none';
            confirmationMessage.style.display = 'block';
            confirmationText.textContent = "Service availability and charges will be confirmed by admin.";
            document.getElementById('id_price_calculation').value = 'Pending confirmation';
            return;
        }

        fetch(`/api/service-price/?service_id=${serviceVal}&distance_km=${distanceKm || ''}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (data.requires_confirmation) {
                        chargeDisplay.style.display = 'none';
                        priceBreakdown.style.display = 'none';
                        confirmationMessage.style.display = 'block';
                        confirmationText.textContent = "Estimated cost will be confirmed. Our admin will contact you soon.";
                        document.getElementById('id_price_calculation').value = 'Pending confirmation';
                    } else {
                        chargeDisplay.style.display = 'none';
                        confirmationMessage.style.display = 'none';
                        priceBreakdown.style.display = 'block';

                        document.getElementById('serviceNameDisplay').textContent = data.service_name;
                        document.getElementById('zoneDisplay').textContent = data.distance_slab;
                        document.getElementById('totalEstimate').textContent = `₹ ${data.charge}`;
                        document.getElementById('readOnlyCost').value = `Estimated Cost: ₹ ${data.charge}`;

                        if (visitingChargeField) visitingChargeField.value = data.charge;
                        document.getElementById('id_price_calculation').value = 'Auto-calculated';
                    }
                }
            });
    }

    function showLocationOnMap(lat, lng, address) {
        const mapSection = document.getElementById('mapSection');
        mapSection.style.display = 'block';
        if (!map) {
            map = new google.maps.Map(document.getElementById('mapContainer'), {
                zoom: 14,
                center: { lat: lat, lng: lng },
                disableDefaultUI: true,
                zoomControl: true
            });
            shopMarker = new google.maps.Marker({ position: { lat: SHOP_LAT, lng: SHOP_LNG }, map: map, icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png' });
        } else {
            map.setCenter({ lat: lat, lng: lng });
        }

        if (marker) marker.setPosition({ lat: lat, lng: lng });
        else {
            marker = new google.maps.Marker({ position: { lat: lat, lng: lng }, map: map, draggable: true });
            marker.addListener('dragend', (e) => {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: e.latLng }, (res, status) => {
                    if (status === 'OK' && res[0]) {
                        onPlaceSelectedFromCoordinate(e.latLng.lat(), e.latLng.lng(), res[0]);
                    }
                });
            });
        }
    }

    function onPlaceSelectedFromCoordinate(lat, lng, res) {
        document.getElementById('addressAutocomplete').value = res.formatted_address;
        let pincode = '', area = '', city = 'Indore', road = '', houseNumber = '';
        res.address_components.forEach(comp => {
            if (comp.types.includes('postal_code')) pincode = comp.long_name;
            if (comp.types.includes('sublocality')) area = comp.long_name;
        });
        processLocation(lat, lng, res.formatted_address, area, city, pincode, road, houseNumber, 'MAP');
    }

    function showMessage(type, msg) {
        const div = document.getElementById('locationMsg');
        div.textContent = msg;
        div.className = `form-text small fw-bold text-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'warning'}`;
    }

    function toggleOtherArea(s) {
        const other = document.getElementById('id_other_area');
        other.style.display = s.value === 'Other' ? 'block' : 'none';
    }

    function performLocationVerification(lat, lng, dist) { } // Placeholder
</script>
{% endblock %}